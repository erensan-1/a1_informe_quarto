<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Enrique Reñé Sánchez (Técnico SIG)">
<meta name="author" content="Cristian González Alonso (Ingeniero de datos)">
<meta name="author" content="Juan Jorge Rosales León (Dirección técnica)">

<title>Metodología empleada para la resolución de la Tarea A1 ‘Hogares sin CIV’</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.5.1/jquery.min.js" integrity="sha512-bLT0Qm9VnAYZDflyKcBaQ2gg0hSYNQrJ8RilYldYQ1FxQYoCLtUjuuRuZo+fjqhx/qtq/1itJ0C2ejDxltZVFg==" crossorigin="anonymous"></script><script src="a1_informe_files/libs/clipboard/clipboard.min.js"></script>
<script src="a1_informe_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="a1_informe_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="a1_informe_files/libs/quarto-html/popper.min.js"></script>
<script src="a1_informe_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="a1_informe_files/libs/quarto-html/anchor.min.js"></script>
<link href="a1_informe_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="a1_informe_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="a1_informe_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="a1_informe_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="a1_informe_files/libs/bootstrap/bootstrap-bb462d781dde1847d9e3ccf7736099dd.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(S:/Enrique/FONDOS/INFORME TECNICO/FONDO_IT_1.png);
background-size: cover;
      }
</style>
<script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" integrity="sha512-c3Nl8+7g4LMSTdrm621y7kf9v3SDPnhxLNhcjFJbKECVnmZHTdo+IRO05sNLTH/D3vA6u1X32ehoLC7WFVdheg==" crossorigin="anonymous"></script>

<script type="application/javascript">define('jquery', [],function() {return window.jQuery;})</script>


<link rel="stylesheet" href="C:\padron\data\vscode\padron_online\A1\styles.css">
</head>

<body class="quarto-light">

<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-right">
      <h1 class="title">Metodología empleada para la resolución de la Tarea A1 ‘Hogares sin CIV’</h1>
                      </div>
  </div>
    
  <div class="quarto-title-meta-author column-page-right">
    <div class="quarto-title-meta-heading">Authors</div>
    <div class="quarto-title-meta-heading">Affiliation</div>
    
      <div class="quarto-title-meta-contents">
      <p class="author"><em>Enrique Reñé Sánchez (Técnico SIG)</em> </p>
    </div>
    <div class="quarto-title-meta-contents">
          <p class="affiliation">
              <img src="S:/Enrique/logos/GRAFCANa_logo_color.png" class="img-fluid" style="width:1in" alt="GRAFCAN Logo">
            </p>
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author"><em>Cristian González Alonso (Ingeniero de datos)</em> </p>
    </div>
    <div class="quarto-title-meta-contents">
        </div>
      <div class="quarto-title-meta-contents">
      <p class="author"><em>Juan Jorge Rosales León (Dirección técnica)</em> </p>
    </div>
    <div class="quarto-title-meta-contents">
        </div>
    </div>

  <div class="quarto-title-meta column-page-right">

        
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Invalid Date</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active" data-toc-expanded="3">
    <h2 id="toc-title">Tabla de contenidos</h2>
   
  <ul>
  <li><a href="#sec-resumen" id="toc-sec-resumen" class="nav-link active" data-scroll-target="#sec-resumen"><span class="header-section-number">1</span> Resumen</a>
  <ul>
  <li><a href="#información-de-partida-y-análisis-inicial" id="toc-información-de-partida-y-análisis-inicial" class="nav-link" data-scroll-target="#información-de-partida-y-análisis-inicial"><span class="header-section-number">1.1</span> Información de partida y análisis inicial</a></li>
  <li><a href="#fuentes-de-datos-complementarias" id="toc-fuentes-de-datos-complementarias" class="nav-link" data-scroll-target="#fuentes-de-datos-complementarias"><span class="header-section-number">1.2</span> Fuentes de datos complementarias</a></li>
  </ul></li>
  <li><a href="#flujo-metodológico" id="toc-flujo-metodológico" class="nav-link" data-scroll-target="#flujo-metodológico"><span class="header-section-number">2</span> Flujo metodológico</a>
  <ul>
  <li><a href="#preparación-del-entorno" id="toc-preparación-del-entorno" class="nav-link" data-scroll-target="#preparación-del-entorno"><span class="header-section-number">2.1</span> Preparación del entorno</a></li>
  <li><a href="#normalización" id="toc-normalización" class="nav-link" data-scroll-target="#normalización"><span class="header-section-number">2.2</span> Normalización</a></li>
  <li><a href="#emparejamiento" id="toc-emparejamiento" class="nav-link" data-scroll-target="#emparejamiento"><span class="header-section-number">2.3</span> Emparejamiento</a>
  <ul class="collapse">
  <li><a href="#hs---vv-match-exacto" id="toc-hs---vv-match-exacto" class="nav-link" data-scroll-target="#hs---vv-match-exacto"><span class="header-section-number">2.3.1</span> HS - VV (match exacto)</a></li>
  <li><a href="#hs---vv-fuzzy-match" id="toc-hs---vv-fuzzy-match" class="nav-link" data-scroll-target="#hs---vv-fuzzy-match"><span class="header-section-number">2.3.2</span> HS - VV (fuzzy match)</a></li>
  <li><a href="#hs---catastro-match-exacto" id="toc-hs---catastro-match-exacto" class="nav-link" data-scroll-target="#hs---catastro-match-exacto"><span class="header-section-number">2.3.3</span> HS - Catastro (match exacto)</a></li>
  <li><a href="#hs---callejero-sitcan-match-exacto-por-código-de-vía" id="toc-hs---callejero-sitcan-match-exacto-por-código-de-vía" class="nav-link" data-scroll-target="#hs---callejero-sitcan-match-exacto-por-código-de-vía"><span class="header-section-number">2.3.4</span> HS - Callejero SITCAN (match exacto por código de vía)</a></li>
  <li><a href="#hs---catastro-fuzzy-match" id="toc-hs---catastro-fuzzy-match" class="nav-link" data-scroll-target="#hs---catastro-fuzzy-match"><span class="header-section-number">2.3.5</span> HS - Catastro (fuzzy match)</a></li>
  <li><a href="#hs---callejero-sitcan-fuzzy-match" id="toc-hs---callejero-sitcan-fuzzy-match" class="nav-link" data-scroll-target="#hs---callejero-sitcan-fuzzy-match"><span class="header-section-number">2.3.6</span> HS - Callejero SITCAN (fuzzy match)</a></li>
  <li><a href="#hs---cc-match-exacto" id="toc-hs---cc-match-exacto" class="nav-link" data-scroll-target="#hs---cc-match-exacto"><span class="header-section-number">2.3.7</span> HS - CC (match exacto)</a></li>
  <li><a href="#hs---cc-fuzzy-match" id="toc-hs---cc-fuzzy-match" class="nav-link" data-scroll-target="#hs---cc-fuzzy-match"><span class="header-section-number">2.3.8</span> HS - CC (fuzzy match)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#resultados" id="toc-resultados" class="nav-link" data-scroll-target="#resultados"><span class="header-section-number">3</span> Resultados</a>
  <ul>
  <li><a href="#distribución-por-municipio" id="toc-distribución-por-municipio" class="nav-link" data-scroll-target="#distribución-por-municipio"><span class="header-section-number">3.1</span> Distribución por municipio</a></li>
  <li><a href="#productos-cartográficos" id="toc-productos-cartográficos" class="nav-link" data-scroll-target="#productos-cartográficos"><span class="header-section-number">3.2</span> Productos cartográficos</a></li>
  </ul></li>
  <li><a href="#análisis-del-residuo" id="toc-análisis-del-residuo" class="nav-link" data-scroll-target="#análisis-del-residuo"><span class="header-section-number">4</span> Análisis del residuo</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content quarto-banner-title-block column-page-right" id="quarto-document-content">





<div id="5321a2d7" class="cell" data-execution_count="1">
<div class="cell-output cell-output-display">

<div class="card mb-3" style="padding:10px; background-color:#f8f9fa; border-left: 5px solid #09488bff;">
  <strong>Proyecto:</strong> Tenerife Padrón 2.0 (Cabildo Tenerife) - Padrón Online (INE)
</div>
</div>
</div>
<p>Mediante la Orden TER/1235/2023 (E2025001009), el Cabildo de Tenerife encarga a Cartográfica de Canarias S.A. (GRAFCAN) la ejecución de tareas de análisis y depuración del padrón de municipios de menos de 20.000 habitantes, en el marco del proyecto <em>TenerifePadrón 2.0</em>, encuadrado a su vez en la iniciativa <em>Padrón Online</em> del INE.</p>
<section id="sec-resumen" class="level1" data-number="1">
<h1 data-number="1"><span class="header-section-number">1</span> Resumen</h1>
<p>Este documento describe la metodología empleada para la resolución de la Tarea A1 (‘Hogares sin CIV’) , que consiste en la asignación de Código de Identificación de Vivienda (CIV) para aquellos hogares que carecen del mismo. La aproximación se centra en la búsqueda de emparejamientos mediante dirección para los ficheros proporcionados por el INE, así como la comparación contra otras fuentes de datos. Tras un emparejamiento exitoso, se realiza la asignación de CIV para el hogar de acuerdo con el procedimiento dispuesto en la <a href="file:///C:/padron/data/vscode/padron_online/A1/Guia_Técnica_de_Subvenciones.pdf" target="_blank">Guía Técnica de Subvenciones</a>.</p>
<p>Dada la inexistencia de un mecanismo de emparejamiento unívoco, la variedad en los formatos de nomenclatura y la incompletitud de las descripciones hasta nivel de inmueble, se ha optado por emplear distintos métodos de emparejamiento basados en coincidencia exacta y coincidencia difusa (aplicando primero los más conservadores y optimizando los menos restrictivos para minimizar los falsos positivos), para las direcciones hasta nivel de parcela.</p>
<p>Los resultados reflejan un <strong>82,25% de asignación</strong> a nivel global tras la comparación con todas las fuentes de datos (asumiendo cierto margen de error para los registros procedentes de coincidencia difusa, si bien se ha trabajado en minimizarlo). Para aquellos registros que forman parte del <strong>residuo (17,75%)</strong>, con correspondiente nueva alta de CIV, se realizó una revisión exhaustiva de los motivos de no asignación, entre los que destacan la falta de descripciones completas en el fichero origen o las fuentes comparadas.</p>
<p>El desarrollo y resultados de los trabajos se plasman en el presente informe, así como en el <a href="file:////nasdepartamento/Saco/Enrique/padron_online/Atlas_v2.pdf" target="_blank">atlas</a> que muestra la distribución espacial de los hogares y estadísticos más relevantes para cada municipio.</p>
<section id="información-de-partida-y-análisis-inicial" class="level2" data-number="1.1">
<h2 data-number="1.1" class="anchored" data-anchor-id="información-de-partida-y-análisis-inicial"><span class="header-section-number">1.1</span> Información de partida y análisis inicial</h2>
<p>La información proporcionada por el INE es la siguiente:</p>
<ul>
<li><p><em>Registros del fichero de hogares sin CIV (HSppmmml.023).</em></p></li>
<li><p><em>Fichero completo de Viviendas del municipio (VVppmmml.023).</em></p></li>
</ul>
<p>Inicialmente, con el fin de recuperar la referencia catastral a 20 dígitos (RC20) desde el fichero de viviendas, se buscó emparejar la dirección <strong>hasta nivel de inmueble</strong>. Sin embargo, debido a la incompletitud de los campos de dirección y la falta de información suficiente en muchos registros, el <strong>nivel de emparejamiento conseguido fue muy bajo</strong>.</p>
<p>Por este motivo, se descartó esta vía y se optó por realizar el emparejamiento <strong>hasta nivel de portal</strong>, lo que garantiza una mayor cobertura de los hogares aunque con menor detalle. De este modo, la asignación de CIV se realizó a partir de la referencia catastral a 14 dígitos (RC14), lo que <strong>implica la incapacidad de asociar la figura del hogar al inmueble.</strong></p>
</section>
<section id="fuentes-de-datos-complementarias" class="level2" data-number="1.2">
<h2 data-number="1.2" class="anchored" data-anchor-id="fuentes-de-datos-complementarias"><span class="header-section-number">1.2</span> Fuentes de datos complementarias</h2>
<p>Si bien la búsqueda se realizó primero contra el fichero de viviendas como fuente preferente para la asignación de CIV, dado que esta solo recupera alrededor del 27% de registros, se buscaron las direcciones de los hogares del fichero HS contra las siguientes fuentes complementarias:</p>
<ul>
<li><strong>Catastro</strong>: ficheros CAT (alfanumérico) y cartografía vectorial (gráfico) con información de fincas, unidades constructivas e inmuebles urbanos y rústicos.</li>
<li><strong>Callejero del SITCAN</strong> (Sistema de Información Territorial de Canarias): gestionado y mantenido por GRAFCAN, constituye la base oficial de referencia para la red viaria de Canarias.</li>
<li><strong>CartoCiudad</strong>: conjunto de datos con información vectorial (portales y manzanas) y alfanumérica de red viaria urbana e interurbana de ámbito nacional.</li>
</ul>
</section>
</section>
<section id="flujo-metodológico" class="level1" data-number="2">
<h1 data-number="2"><span class="header-section-number">2</span> Flujo metodológico</h1>
<p>La asignación de CIV a cada hogar se desarrolla en una secuencia de etapas, resumidas a continuación para proporcionar una visión global del proceso:</p>
<ol type="1">
<li><p><strong>Preparación del entorno:</strong></p>
<ul>
<li><p>Importación de librerías para manejo de datos (<code>pandas</code>, <code>geopandas</code>, <code>sqlalchemy</code>), geoprocesamiento (<code>shapely</code>), coincidencia difusa (<code>rapidfuzz</code>, <code>sklearn</code>) y conexión a PostgreSQL/PostGIS.</p></li>
<li><p>Definición de diccionarios de normalización: equivalencias oficiales para desabreviación, casos de abreviación detectados manualmente, equivalencias de nombres de calles detectadas manualmente, casos especiales donde se debe incluir información de bloque/portal.</p></li>
</ul></li>
<li><p><strong>Normalización</strong>: para mejorar la capacidad de emparejamiento se aplican una serie de funciones de preprocesamiento (conversión a mayúsculas, eliminación de acentos y carácteres especiales, separación de sufijos y prefijos, etc). Dicho proceso se aplica tanto al registro procedente del fichero HS como al de la fuente contra la que se compara.</p></li>
<li><p><strong>Carga de datos</strong>: conexión a la base de datos para obtener los ficheros HS y las fuentes a comparar (viviendas, catastro, callejero SITCAN y cartociudad).</p></li>
<li><p><strong>Emparejamiento</strong>:</p>
<p>Primero se ha aplicado el método más conservador (coincidencia exacta) y luego aquellos menos restrictivos (coincidencia difusa o fuzzy matching). Este proceso se realiza de forma iterativa cruzando las descripciones contra las fuentes de referencia, repitiendo un esquema similar en cascada. Así pues, primero se intenta completar con VV, y para aquellos registros pendientes de asignación se cruza contra catastro, callejero SITCAN y finalmente CartoCiudad.</p>
<ul>
<li><p><strong>Match exacto</strong>: se busca coincidencia directa entre la dirección normalizada de HS y la fuente. Si coincide se asigna la RC14, las coordenadas, y método-fuente de emparejamiento.</p></li>
<li><p><strong>Fuzzy match</strong>: se busca coincidencia de similitud textual con RapidFuzz + TF-IDF + nearest neighbors. Se valida el match por nivel de similitud (umbral de <em>score</em>) y la premisa de coincidencia exacta de código de municipio y portal entre los registros. Si cumple los criterios se asigna RC14, coordenadas y método-fuente de emparejamiento.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Filtros y umbrales
</div>
</div>
<div class="callout-body-container callout-body">
<p>Aunque el criterio principal de validación del emparejamiento por cadenas ha sido el <em>score</em> de <code>rapidfuzz</code>, previamente se aplicó un filtro de preselección basado en <em>Nearest Neighbors</em> sobre vectores TF-IDF. Este filtro inicial permite identificar, para cada hogar, la dirección candidata más próxima en el espacio de n-gramas y descartar coincidencias con baja similitud, reduciendo así el riesgo de falsos positivos en la comparación final.</p>
<p>El umbral de similitud para aceptar emparejamientos varía en cada proceso, y se asigna tras una calibración manual orientada a equilibrar recuperación y reducción de falsos positivos. En general, se sitúa entre el 70 % y el 80 %.</p>
</div>
</div></li>
</ul></li>
<li><p><strong>Actualización y exportación</strong>: se actualiza el fichero HS con las nuevas asignaciones y campos completos. Se exportan resultados a archivos excel para revisión manual.</p></li>
<li><p><strong>Métricas de evaluación</strong>: tras cada proceso se reportan el total de hogares de entrada, los asignados en esa fase, el porcentaje de coincidencia exacta o difusa y la asignación acumulada (cobertura total).</p></li>
<li><p><strong>Asignación de CIV</strong>:</p>
<p>Dado que el detalle al que se resuelve el emparejamiento es a nivel de parcela (y no de inmueble por las motivos expuestos anteriormente), se ha recuperado para cada emparejamiento la RC14:</p>
<ul>
<li><p><strong>Fichero de viviendas</strong>: recuperación directa desde el campo ‘CIV’ (primeros 14 dígitos).</p></li>
<li><p><strong>Fuente catastro</strong>: recuperación directa desde el campo ‘id_parcela_catastral’.</p>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Generación de puntos
</div>
</div>
<div class="callout-body-container callout-body">
<p>Tras unir la cartografía vectorial con el fichero alfanumérico CAT, se genera un punto dentro de cada parcela que queda contenido en su superficie. No se utiliza el centroide, ya que en parcelas irregulares o con huecos podría situarse fuera de la geometría, por lo que se calcula un punto ajustado garantizando su ubicación interna.</p>
</div>
</div></li>
<li><p><strong>Fuentes callejero y cartociudad</strong>: dado que el emparejamiento está asociado a un punto de la capa de portales, se recupera la RC14 por la vía espacial mediante cruce con la geometría vectorial de las parcelas catastrales.</p></li>
</ul>
<p>Una vez recuperada la RC14 para aquellos registros con emparejamiento exitoso, se aplica el proceso de generación del CIV a cada hogar de acuerdo con las directrices recogidas en la <a href="file:///C:/padron/data/vscode/padron_online/A1/Guia_Técnica_de_Subvenciones.pdf" target="_blank">Guía Técnica de Subvenciones</a>.</p></li>
<li><p><strong>Ficheros de salida</strong>:</p>
<p>Tras la modificación del fichero HS con los nuevos emparejamientos y la generación de altas de viviendas para aquellos registros sin emparejamiento exitoso, se generan los siguientes archivos de salida de acuerdo con la estructura de datos establecida:</p>
<ul>
<li><p><em>HSppmmmA.023: registros del fichero de hogares con CIV cumplimentado.</em></p></li>
<li><p><em>VAppmmmA.023: registros del fichero de alta de viviendas con CIV nuevo.</em></p></li>
</ul></li>
</ol>
<section id="preparación-del-entorno" class="level2" data-number="2.1">
<h2 data-number="2.1" class="anchored" data-anchor-id="preparación-del-entorno"><span class="header-section-number">2.1</span> Preparación del entorno</h2>
<p>Diccionario de abreviaciones:</p>
<div id="8fb83828" class="cell" data-execution_count="3">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>SIGLAS_VIA <span class="op">=</span> {</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AL'</span>: <span class="st">'ALAMEDA'</span>, <span class="st">'AD'</span>: <span class="st">'ALDEA'</span>, <span class="st">'AP'</span>: <span class="st">'APARTAMENTOS'</span>, <span class="st">'AY'</span>: <span class="st">'ARROYO'</span>, <span class="st">'AV'</span>: <span class="st">'AVENIDA'</span>,</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BJ'</span>: <span class="st">'BAJADA'</span>, <span class="st">'BR'</span>: <span class="st">'BARRANCO'</span>, <span class="st">'BO'</span>: <span class="st">'BARRIO'</span>, <span class="st">'BL'</span>: <span class="st">'BLOQUE'</span>, <span class="st">'CL'</span>: <span class="st">'CALLE'</span>,</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CJ'</span>: <span class="st">'CALLEJA'</span>, <span class="st">'CM'</span>: <span class="st">'CAMINO'</span>, <span class="st">'CR'</span>: <span class="st">'CARRERA'</span>, <span class="st">'CS'</span>: <span class="st">'CASERIO'</span>, <span class="st">'CH'</span>: <span class="st">'CHALET'</span>,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CO'</span>: <span class="st">'COLONIA'</span>, <span class="st">'CN'</span>: <span class="st">'COSTANILLA'</span>, <span class="st">'CT'</span>: <span class="st">'CARRETERA'</span>, <span class="st">'CU'</span>: <span class="st">'CUESTA'</span>, <span class="st">'ED'</span>: <span class="st">'EDIFICIO'</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'EL'</span>: <span class="st">'ESCALINATA'</span>, <span class="st">'ES'</span>: <span class="st">'ESCALERA'</span>, <span class="st">'GL'</span>: <span class="st">'GLORIETA'</span>, <span class="st">'GR'</span>: <span class="st">'GRUPO'</span>, <span class="st">'LG'</span>: <span class="st">'LUGAR'</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'MC'</span>: <span class="st">'MERCADO'</span>, <span class="st">'MN'</span>: <span class="st">'MUNICIPIO'</span>, <span class="st">'MZ'</span>: <span class="st">'MANZANA'</span>, <span class="st">'PA'</span>: <span class="st">'PASEO ALTO'</span>, <span class="st">'PB'</span>: <span class="st">'POBLADO'</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PD'</span>: <span class="st">'PASADIZO'</span>, <span class="st">'PJ'</span>: <span class="st">'PASAJE'</span>, <span class="st">'PL'</span>: <span class="st">'PLACETA'</span>, <span class="st">'PO'</span>: <span class="st">'PASEO BAJO'</span>, <span class="st">'PP'</span>: <span class="st">'PASEO'</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PQ'</span>: <span class="st">'PARQUE'</span>, <span class="st">'PR'</span>: <span class="st">'PORTALES'</span>, <span class="st">'PS'</span>: <span class="st">'PASO'</span>, <span class="st">'PT'</span>: <span class="st">'PATIO'</span>, <span class="st">'PU'</span>: <span class="st">'PLAZUELA'</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'PZ'</span>: <span class="st">'PLAZA'</span>, <span class="st">'RA'</span>: <span class="st">'RAMAL'</span>, <span class="st">'RB'</span>: <span class="st">'RAMBLA'</span>, <span class="st">'RC'</span>: <span class="st">'RINCONADA'</span>, <span class="st">'RD'</span>: <span class="st">'RONDA'</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'RP'</span>: <span class="st">'RAMPA'</span>, <span class="st">'RR'</span>: <span class="st">'RIBERA'</span>, <span class="st">'SC'</span>: <span class="st">'SECTOR'</span>, <span class="st">'SD'</span>: <span class="st">'SENDA'</span>, <span class="st">'SU'</span>: <span class="st">'SUBIDA'</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'TO'</span>: <span class="st">'TORRE'</span>, <span class="st">'TR'</span>: <span class="st">'TRAVESÍA'</span>, <span class="st">'UR'</span>: <span class="st">'URBANIZACIÓN'</span>, <span class="st">'URB'</span>: <span class="st">'URBANIZACIÓN'</span>, <span class="st">'VI'</span>: <span class="st">'VÍA'</span>, <span class="st">'ZO'</span>: <span class="st">'ZONA'</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'AVDA'</span>: <span class="st">'AVENIDA'</span>, <span class="st">'CTRA'</span>: <span class="st">'CARRETERA'</span>, <span class="st">'CLLON'</span>: <span class="st">'CALLEJON'</span>, <span class="st">'TRVA'</span>: <span class="st">'TRAVESIA'</span>, <span class="co">#Detectadas a mano</span></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'CMNO'</span>: <span class="st">'CAMINO'</span>, <span class="st">'PSAJE'</span>: <span class="st">'PASAJE'</span>, <span class="st">'BRANC'</span>: <span class="st">'BARRANCO'</span>, <span class="st">'PZTA'</span>: <span class="st">'PLAZOLETA'</span>, <span class="st">'POLIG'</span>: <span class="st">'POLIGONO'</span>, <span class="co">#Detectadas a mano</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'BARDA'</span>: <span class="st">'BARRIADA'</span>, <span class="st">'TRVAL'</span>: <span class="st">'TRASVERSAL'</span>, <span class="st">'ACCES'</span>: <span class="st">'ACCESO'</span>, <span class="st">'CZDA'</span>:<span class="st">'CALZADA'</span>, <span class="st">'CZADA'</span>: <span class="st">'CALZADA'</span>, <span class="st">'VREDA'</span>: <span class="st">'VEREDA'</span> <span class="co">#Detectadas a mano</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Diccionario de vías equivalentes:</p>
<div id="e4660dea" class="cell" data-execution_count="4">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>equivalencias_vias <span class="op">=</span> {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'CARRETERA'</span>, <span class="st">'OROTAVA GUANCHA DOSCIENTOS VEINTIUNO'</span>): (<span class="st">'CARRETERA'</span>, <span class="st">'GENERAL OROTAVA GUANCHA'</span>),</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'CARRETERA'</span>, <span class="st">'SAN JOSE DOS MIL DOSCIENTOS CATORCE'</span>): (<span class="st">'CARRETERA'</span>, <span class="st">'SAN JOSE'</span>),</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'CARRETERA'</span>, <span class="st">'GENERAL ARGUAYO'</span>): (<span class="st">'AVENIDA'</span>, <span class="st">'DE LAS ALFARERAS'</span>),</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'CARRETERA'</span>, <span class="st">'VECINAL DE EL SAUZAL'</span>): (<span class="st">'AVENIDA'</span>, <span class="st">'PRESIDENTE PAULINO RIVERO BAUTE'</span>),</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    (<span class="st">'CALLE'</span>, <span class="st">'SAN JOSE LA CISNERA'</span>): (<span class="st">'CALLE'</span>, <span class="st">'SAN JOSE'</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Diccionario de direcciones que requieren añadir portal para mejorar su emparejamiento:</p>
<div id="45929d51" class="cell" data-execution_count="5">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>direcciones_con_port <span class="op">=</span> {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="st">'51 CARRETERA GENERAL 92'</span>: <span class="va">True</span>,</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 CALLE BENAVIDES 2'</span>: <span class="va">True</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 CALLE BENAVIDES 4'</span>: <span class="va">True</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 CALLE BENAVIDES 5'</span>: <span class="va">True</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 CALLE BENAVIDES 6'</span>: <span class="va">True</span>,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 CALLE BENAVIDES 8'</span>: <span class="va">True</span>,</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="st">'5 CALLE LLANOS DEL PORIS 97'</span>: <span class="va">True</span>,</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="st">'5 CALLE SIETE URBANIZACION CLUB CASABLANCA 0000S'</span>: <span class="va">True</span>,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10 GRUPO VIVIENDAS FUNCIONARIOS 1'</span>: <span class="va">True</span>, </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10 GRUPO VIVIENDAS FUNCIONARIOS 2'</span>: <span class="va">True</span>, </span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10 GRUPO VIVIENDAS FUNCIONARIOS 3'</span>: <span class="va">True</span>, </span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="st">'10 CALLE DONA CLOTILDE 2'</span>: <span class="va">True</span>, </span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="st">'12 PASEO URBANIZACION BAHIA 1'</span>: <span class="va">True</span>, </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="st">'12 CALLE AULAGA LA 2'</span>: <span class="va">True</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="st">'12 CALLE AULAGA LA 4'</span>: <span class="va">True</span>,</span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="st">'12 CALLE AULAGA LA 6'</span>: <span class="va">True</span>,</span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    <span class="st">'15 CALLE ARAUZ 2'</span>: <span class="va">True</span>,</span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="st">'15 CALLE ARAUZ 4'</span>: <span class="va">True</span>,</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="st">'15 CALLE VISTAS AL MAR 1'</span>: <span class="va">True</span>,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">'15 CALLE VISTAS AL MAR 3'</span>: <span class="va">True</span>,</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="st">'15 CALLE HERMOGENES AFONSO DE LA CRUZ 49'</span>: <span class="va">True</span>,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">'25 CALLE REAL 41'</span>: <span class="va">True</span>,</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="st">'32 AVENIDA COLON 2'</span>: <span class="va">True</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="st">'32 CALLE PORTUGAL 2'</span>: <span class="va">True</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="st">'32 CARRETERA TF24 30'</span>: <span class="va">True</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>    <span class="st">'32 CALLE ANTONIO GONZALEZ 6'</span>: <span class="va">True</span>,</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>    <span class="st">'32 CALLE VALDES 29'</span>: <span class="va">True</span>,</span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>    <span class="st">'32 CALLE ITALIA 19'</span>: <span class="va">True</span>,</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">'34 AVENIDA AGUAS LAS 4'</span>: <span class="va">True</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 CAMINO ANTIGUO LA CUESTA 16'</span>: <span class="va">True</span>,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 CALLE GUANCHES 121'</span>: <span class="va">True</span>,</span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 CALLE GUANCHES 128'</span>: <span class="va">True</span>,</span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 CARRETERA NUEVA CORUJERA 71'</span>: <span class="va">True</span>,</span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 AVENIDA PALMERAS LAS 4'</span>: <span class="va">True</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 CALLE LOMO ROMAN 3'</span>: <span class="va">True</span>,</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="st">'39 CALLE CODESO 1'</span>: <span class="va">True</span>,</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CALLE TAMARA 22'</span>: <span class="va">True</span>,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CARRETERA PUERTO A 20'</span>: <span class="va">True</span>,</span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CALLE CALETA DEL JURADO 3'</span>: <span class="va">True</span>,</span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CALLE CALETA DEL JURADO 5'</span>: <span class="va">True</span>,</span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CALLE LAJIAL EL 7'</span>: <span class="va">True</span>,</span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CALLE ALCALDE JUAN GARCIA DORTA 2'</span>: <span class="va">True</span>,</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="st">'40 CALLE ALCALDE JUAN GARCIA DORTA 14'</span>: <span class="va">True</span>,</span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>    <span class="st">'41 CALLE SAN NICOLAS 128'</span>: <span class="va">True</span>,</span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>    <span class="st">'41 CARRETERA GENERAL DEL NORTE 17'</span>: <span class="va">True</span>,</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="st">'41 CARRETERA GENERAL DEL NORTE 0031A'</span>: <span class="va">True</span>,</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    <span class="st">'41 CARRETERA GENERAL DEL NORTE 42'</span>: <span class="va">True</span>,</span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46 CALLE MOLINILLO EL 12'</span>: <span class="va">True</span>,</span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46 CALLE ALCALDE MAXIMO GONZALEZ 21'</span>: <span class="va">True</span>,</span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46 CALLE ALCALDE MAXIMO GONZALEZ 23'</span>: <span class="va">True</span>,</span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46 CALLE MANUEL GONZALEZ 1'</span>: <span class="va">True</span>,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46 CALLE MANUEL GONZALEZ 3'</span>: <span class="va">True</span>,</span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="st">'46 CALLE MANUEL GONZALEZ 17'</span>: <span class="va">True</span>,</span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    <span class="st">'51 CARRETERA GENERAL 94'</span>: <span class="va">True</span>,</span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="st">'51 CALLE HORNO DE LA TEJA 33'</span>: <span class="va">True</span>,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    <span class="st">'52 CAMINO REAL 71'</span>: <span class="va">True</span>,</span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="st">'52 CAMINO JAMA DE 36'</span>: <span class="va">True</span>,</span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="st">'52 CAMINO JAMA DE 64'</span>: <span class="va">True</span>,</span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="normalización" class="level2" data-number="2.2">
<h2 data-number="2.2" class="anchored" data-anchor-id="normalización"><span class="header-section-number">2.2</span> Normalización</h2>
<p>Definición de funciones de limpieza y normalización de las descripciones:</p>
<div id="180ba776" class="cell" data-execution_count="6">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> limpiar_texto(texto):</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> <span class="bu">isinstance</span>(texto, <span class="bu">str</span>):</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>        texto <span class="op">=</span> <span class="bu">str</span>(texto)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> texto.upper().strip()</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> unicodedata.normalize(<span class="st">'NFKD'</span>, texto)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> <span class="st">''</span>.join(c <span class="cf">for</span> c <span class="kw">in</span> texto <span class="cf">if</span> <span class="kw">not</span> unicodedata.combining(c))  <span class="co"># Quitar acentos</span></span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> re.sub(<span class="vs">r'</span><span class="pp">[^A-Z0-9 ]</span><span class="vs">'</span>, <span class="st">''</span>, texto)  <span class="co"># Eliminar símbolos, puntuación, etc.</span></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> texto</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalizar_numero_portal(numer):</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> <span class="bu">str</span>(numer).strip().upper()</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Separar parte numérica y letras</span></span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> re.match(<span class="vs">r'</span><span class="dv">^</span><span class="vs">0</span><span class="op">*</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)(</span><span class="pp">[A-Z]</span><span class="op">*</span><span class="kw">)</span><span class="dv">$</span><span class="vs">'</span>, texto)  <span class="co"># 0024B → 24 + B</span></span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> match:</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>        numero <span class="op">=</span> match.group(<span class="dv">1</span>)</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>        sufijo <span class="op">=</span> match.group(<span class="dv">2</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> numero <span class="op">+</span> sufijo</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> limpiar_texto(texto)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalizar_direccion(cmun, tvia, nvia, numer, bloque<span class="op">=</span><span class="va">None</span>, bloq<span class="op">=</span><span class="va">None</span>, port<span class="op">=</span><span class="va">None</span>):</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a>        cmun_norm <span class="op">=</span> <span class="bu">str</span>(<span class="bu">int</span>(cmun))</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> (<span class="pp">ValueError</span>, <span class="pp">TypeError</span>):</span>
<span id="cb4-26"><a href="#cb4-26" aria-hidden="true" tabindex="-1"></a>        cmun_norm <span class="op">=</span> limpiar_texto(cmun)</span>
<span id="cb4-27"><a href="#cb4-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-28"><a href="#cb4-28" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb4-29"><a href="#cb4-29" aria-hidden="true" tabindex="-1"></a>        tvia_str <span class="op">=</span> <span class="bu">str</span>(tvia).strip().upper()</span>
<span id="cb4-30"><a href="#cb4-30" aria-hidden="true" tabindex="-1"></a>        tvia_raw <span class="op">=</span> SIGLAS_VIA.get(tvia_str, tvia_str)</span>
<span id="cb4-31"><a href="#cb4-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb4-32"><a href="#cb4-32" aria-hidden="true" tabindex="-1"></a>        tvia_raw <span class="op">=</span> <span class="bu">str</span>(tvia)</span>
<span id="cb4-33"><a href="#cb4-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-34"><a href="#cb4-34" aria-hidden="true" tabindex="-1"></a>    tvia_norm <span class="op">=</span> limpiar_texto(tvia_raw)</span>
<span id="cb4-35"><a href="#cb4-35" aria-hidden="true" tabindex="-1"></a>    nvia_norm <span class="op">=</span> limpiar_texto(nvia)</span>
<span id="cb4-36"><a href="#cb4-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-37"><a href="#cb4-37" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Aplicar equivalencias si existen</span></span>
<span id="cb4-38"><a href="#cb4-38" aria-hidden="true" tabindex="-1"></a>    key_eq <span class="op">=</span> (tvia_norm, nvia_norm)</span>
<span id="cb4-39"><a href="#cb4-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> key_eq <span class="kw">in</span> equivalencias_vias:</span>
<span id="cb4-40"><a href="#cb4-40" aria-hidden="true" tabindex="-1"></a>        nuevo_tvia, nuevo_nvia <span class="op">=</span> equivalencias_vias[key_eq]</span>
<span id="cb4-41"><a href="#cb4-41" aria-hidden="true" tabindex="-1"></a>        tvia_norm <span class="op">=</span> limpiar_texto(nuevo_tvia)</span>
<span id="cb4-42"><a href="#cb4-42" aria-hidden="true" tabindex="-1"></a>        nvia_norm <span class="op">=</span> limpiar_texto(nuevo_nvia)</span>
<span id="cb4-43"><a href="#cb4-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-44"><a href="#cb4-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Normalizar número de portal</span></span>
<span id="cb4-45"><a href="#cb4-45" aria-hidden="true" tabindex="-1"></a>    numer_norm <span class="op">=</span> normalizar_numero_portal(numer)</span>
<span id="cb4-46"><a href="#cb4-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-47"><a href="#cb4-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Clave base</span></span>
<span id="cb4-48"><a href="#cb4-48" aria-hidden="true" tabindex="-1"></a>    clave_base <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>cmun_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>tvia_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>nvia_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>numer_norm<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-49"><a href="#cb4-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-50"><a href="#cb4-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Añadir sufijo si está en direcciones_con_port</span></span>
<span id="cb4-51"><a href="#cb4-51" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> clave_base <span class="kw">in</span> direcciones_con_port:</span>
<span id="cb4-52"><a href="#cb4-52" aria-hidden="true" tabindex="-1"></a>        sufijo <span class="op">=</span> <span class="st">""</span></span>
<span id="cb4-53"><a href="#cb4-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-54"><a href="#cb4-54" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Procesar BLOQ</span></span>
<span id="cb4-55"><a href="#cb4-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(bloq, <span class="bu">str</span>) <span class="kw">and</span> bloq.strip():</span>
<span id="cb4-56"><a href="#cb4-56" aria-hidden="true" tabindex="-1"></a>            letras_bloq <span class="op">=</span> re.findall(<span class="vs">r'</span><span class="pp">[A-Z]</span><span class="vs">'</span>, bloq.upper())</span>
<span id="cb4-57"><a href="#cb4-57" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> letras_bloq:</span>
<span id="cb4-58"><a href="#cb4-58" aria-hidden="true" tabindex="-1"></a>                sufijo <span class="op">+=</span> letras_bloq[<span class="op">-</span><span class="dv">1</span>]  <span class="co"># última letra útil</span></span>
<span id="cb4-59"><a href="#cb4-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-60"><a href="#cb4-60" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Procesar PORT</span></span>
<span id="cb4-61"><a href="#cb4-61" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="bu">isinstance</span>(port, <span class="bu">str</span>) <span class="kw">and</span> port.strip():</span>
<span id="cb4-62"><a href="#cb4-62" aria-hidden="true" tabindex="-1"></a>            letras_port <span class="op">=</span> re.findall(<span class="vs">r'</span><span class="pp">[A-Z]</span><span class="vs">'</span>, port.upper())</span>
<span id="cb4-63"><a href="#cb4-63" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> letras_port:</span>
<span id="cb4-64"><a href="#cb4-64" aria-hidden="true" tabindex="-1"></a>                sufijo <span class="op">+=</span> letras_port[<span class="op">-</span><span class="dv">1</span>]  <span class="co"># última letra útil</span></span>
<span id="cb4-65"><a href="#cb4-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-66"><a href="#cb4-66" aria-hidden="true" tabindex="-1"></a>        <span class="co"># Agregar al número de portal</span></span>
<span id="cb4-67"><a href="#cb4-67" aria-hidden="true" tabindex="-1"></a>        clave_base <span class="op">=</span> <span class="ss">f"</span><span class="sc">{</span>cmun_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>tvia_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>nvia_norm<span class="sc">}</span><span class="ss"> </span><span class="sc">{</span>numer_norm<span class="sc">}{</span>sufijo<span class="sc">}</span><span class="ss">"</span></span>
<span id="cb4-68"><a href="#cb4-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-69"><a href="#cb4-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> clave_base</span>
<span id="cb4-70"><a href="#cb4-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-71"><a href="#cb4-71" aria-hidden="true" tabindex="-1"></a><span class="co"># Función normalización de civ (de 24 coger 14 dígitos)</span></span>
<span id="cb4-72"><a href="#cb4-72" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalizar_civ(civ):</span>
<span id="cb4-73"><a href="#cb4-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.isna(civ):</span>
<span id="cb4-74"><a href="#cb4-74" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> civ</span>
<span id="cb4-75"><a href="#cb4-75" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb4-76"><a href="#cb4-76" aria-hidden="true" tabindex="-1"></a>        civ_str <span class="op">=</span> <span class="bu">str</span>(civ).zfill(<span class="dv">24</span>)  <span class="co"># Convierte a string y rellena a 24 dígitos</span></span>
<span id="cb4-77"><a href="#cb4-77" aria-hidden="true" tabindex="-1"></a>        primeros_14 <span class="op">=</span> civ_str[:<span class="dv">14</span>]   <span class="co"># Toma los primeros 14 dígitos</span></span>
<span id="cb4-78"><a href="#cb4-78" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> primeros_14</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
<p>Aplicación de funciones de normalización:</p>
<div id="f676a23e" class="cell" data-execution_count="8">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizar direcciones</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>df_hs[<span class="st">'direccion_hs'</span>] <span class="op">=</span> df_hs.<span class="bu">apply</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'cmun'</span>], row[<span class="st">'tvia'</span>], row[<span class="st">'nvia'</span>], row[<span class="st">'numer'</span>],</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>        bloq<span class="op">=</span>row.get(<span class="st">'bloq'</span>), port<span class="op">=</span>row.get(<span class="st">'port'</span>)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>df_vv[<span class="st">'direccion_vv'</span>] <span class="op">=</span> df_vv.<span class="bu">apply</span>(</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(row[<span class="st">'cmun_dgc'</span>], row[<span class="st">'tvia_dgc'</span>], row[<span class="st">'nvia_dgc'</span>], row[<span class="st">'numer'</span>]),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="emparejamiento" class="level2" data-number="2.3">
<h2 data-number="2.3" class="anchored" data-anchor-id="emparejamiento"><span class="header-section-number">2.3</span> Emparejamiento</h2>
<section id="hs---vv-match-exacto" class="level3" data-number="2.3.1">
<h3 data-number="2.3.1" class="anchored" data-anchor-id="hs---vv-match-exacto"><span class="header-section-number">2.3.1</span> HS - VV (match exacto)</h3>
<div id="9b94123d" class="cell" data-collapse="true" data-execution_count="9">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA VV (MATCH EXACTO) ===</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Aplicación de la transformación de civ</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>df_vv[<span class="st">'civ_normalizado'</span>] <span class="op">=</span> df_vv[<span class="st">'civ'</span>].<span class="bu">apply</span>(normalizar_civ)</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a><span class="co"># Creación de diccionario para búsqueda rápida: dirección_vv → civ</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>dic_direccion_civ <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(df_vv[<span class="st">'direccion_vv'</span>], df_vv[<span class="st">'civ_normalizado'</span>]))</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs[<span class="st">'civ'</span>].notna(), <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'match exacto - vv'</span>  <span class="co"># Asignación de método y fuente de datos</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignación CIV en df_hs si la direccion_hs existe exactamente en VV</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>df_hs[<span class="st">'civ'</span>] <span class="op">=</span> df_hs[<span class="st">'direccion_hs'</span>].<span class="bu">map</span>(dic_direccion_civ)</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs[<span class="st">'civ'</span>].notna(), <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'match exacto - vv'</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Adición de DIRECCION_VV PARA COMPARAR</span></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>df_hs_asignados <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].notna()].copy()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>dic_direccion_vv <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(df_vv[<span class="st">'direccion_vv'</span>], df_vv[<span class="st">'direccion_vv'</span>]))</span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>df_hs_asignados[<span class="st">'direccion_vv'</span>] <span class="op">=</span> df_hs_asignados[<span class="st">'direccion_hs'</span>].<span class="bu">map</span>(dic_direccion_vv)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs_asignados.index, <span class="st">'direccion_vv'</span>] <span class="op">=</span> df_hs_asignados[<span class="st">'direccion_vv'</span>]</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Comprobación de columnas necesarias antes de asignar</span></span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]:</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>        df_hs[col] <span class="op">=</span> pd.NA</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Diccionarios para coordenadas y SRID</span></span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>dic_coor_x <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(df_vv[<span class="st">'direccion_vv'</span>], df_vv[<span class="st">'coor_x'</span>]))</span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>dic_coor_y <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(df_vv[<span class="st">'direccion_vv'</span>], df_vv[<span class="st">'coor_y'</span>]))</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>dic_srid <span class="op">=</span> <span class="bu">dict</span>(<span class="bu">zip</span>(df_vv[<span class="st">'direccion_vv'</span>], df_vv[<span class="st">'srid'</span>]))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignación de coordenadas y SRID solo a los registros emparejados</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>mask_asignados <span class="op">=</span> df_hs[<span class="st">'civ'</span>].notna()</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>df_hs.loc[mask_asignados, <span class="st">'coor_x'</span>] <span class="op">=</span> df_hs.loc[mask_asignados, <span class="st">'direccion_hs'</span>].<span class="bu">map</span>(dic_coor_x)</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>df_hs.loc[mask_asignados, <span class="st">'coor_y'</span>] <span class="op">=</span> df_hs.loc[mask_asignados, <span class="st">'direccion_hs'</span>].<span class="bu">map</span>(dic_coor_y)</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>df_hs.loc[mask_asignados, <span class="st">'srid'</span>] <span class="op">=</span> df_hs.loc[mask_asignados, <span class="st">'direccion_hs'</span>].<span class="bu">map</span>(dic_srid)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Métricas</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>total_hs <span class="op">=</span> <span class="bu">len</span>(df_hs)</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>asignados_exacto <span class="op">=</span> df_hs[<span class="st">'civ'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>porcentaje_exacto <span class="op">=</span> (asignados_exacto <span class="op">/</span> total_hs) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> total_hs <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== HS CONTRA VV (COINCIDENCIA EXACTA)==="</span>)</span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros HS: </span><span class="sc">{</span>total_hs<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por coincidencia exacta: </span><span class="sc">{</span>asignados_exacto<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Porcentaje de coincidencia exacta: </span><span class="sc">{</span>porcentaje_exacto<span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Exportación de archivos para revisión manual</span></span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a>df_hs_restantes <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].isna()].copy()</span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>df_hs_asignados <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].notna()].copy()</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-50"><a href="#cb6-50" aria-hidden="true" tabindex="-1"></a><span class="co"># df_hs.to_excel('hs_contra_vv_match_exacto_completo.xlsx', index=False)</span></span>
<span id="cb6-51"><a href="#cb6-51" aria-hidden="true" tabindex="-1"></a>df_hs_asignados.to_excel(<span class="st">'hs_contra_vv_match_exacto_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb6-52"><a href="#cb6-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-53"><a href="#cb6-53" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Archivos exportados:"</span>)</span>
<span id="cb6-54"><a href="#cb6-54" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_vv_match_exacto_con_civ.xlsx"</span>)</span>
<span id="cb6-55"><a href="#cb6-55" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_vv_match_exacto_completo.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---vv-fuzzy-match" class="level3" data-number="2.3.2">
<h3 data-number="2.3.2" class="anchored" data-anchor-id="hs---vv-fuzzy-match"><span class="header-section-number">2.3.2</span> HS - VV (fuzzy match)</h3>
<div id="b240c9ea" class="cell" data-collapse="true" data-execution_count="10">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA VV (FUZZY MATCHING) ===</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co"># TF-IDF vectorización</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>vectorizer_finca <span class="op">=</span> TfidfVectorizer(analyzer<span class="op">=</span><span class="st">'char_wb'</span>, ngram_range<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>tfidf_vv <span class="op">=</span> vectorizer_finca.fit_transform(df_vv[<span class="st">'direccion_vv'</span>].fillna(<span class="st">''</span>))</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>tfidf_hs_restantes <span class="op">=</span> vectorizer_finca.transform(df_hs_restantes[<span class="st">'direccion_hs'</span>].fillna(<span class="st">''</span>))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Fuzzy matching solo para los registros restantes</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>nn <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">1</span>, metric<span class="op">=</span><span class="st">'cosine'</span>).fit(tfidf_vv)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>distancias, indices <span class="op">=</span> nn.kneighbors(tfidf_hs_restantes)</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Similitud y sugerencia de CIV</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>df_hs_restantes[<span class="st">'similitud_vv'</span>] <span class="op">=</span> <span class="dv">1</span> <span class="op">-</span> distancias.flatten()</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>civs_raw <span class="op">=</span> df_vv.iloc[indices.flatten()][<span class="st">'civ'</span>].values</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>df_hs_restantes[<span class="st">'civ_sugerido'</span>] <span class="op">=</span> [normalizar_civ(c) <span class="cf">for</span> c <span class="kw">in</span> civs_raw]</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>df_hs_restantes[<span class="st">'indice_vv'</span>] <span class="op">=</span> indices.flatten()</span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a><span class="co"># Función que valida con fuzzy + numer antes de asignar 'civ'</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> aplicar_civ_vv(row):</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>        num_hs <span class="op">=</span> <span class="bu">int</span>(<span class="bu">str</span>(row[<span class="st">'numer'</span>]).lstrip(<span class="st">'0'</span>) <span class="kw">or</span> <span class="st">'0'</span>)</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>        num_vv <span class="op">=</span> <span class="bu">int</span>(<span class="bu">str</span>(df_vv.iloc[row[<span class="st">'indice_vv'</span>]][<span class="st">'numer'</span>]).lstrip(<span class="st">'0'</span>) <span class="kw">or</span> <span class="st">'0'</span>)</span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>        cmun_hs <span class="op">=</span> row.get(<span class="st">'cmun'</span>, <span class="va">None</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a>        cmun_vv <span class="op">=</span> df_vv.iloc[row[<span class="st">'indice_vv'</span>]][<span class="st">'cmun_dgc'</span>]</span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> row[<span class="st">'similitud_vv'</span>] <span class="op">&gt;=</span> <span class="fl">0.70</span> <span class="kw">and</span> num_hs <span class="op">==</span> num_vv <span class="kw">and</span> cmun_hs <span class="op">==</span> cmun_vv:</span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>            direccion_vv <span class="op">=</span> df_vv.iloc[row[<span class="st">'indice_vv'</span>]][<span class="st">'direccion_vv'</span>]</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>            score <span class="op">=</span> fuzz.token_set_ratio(row[<span class="st">'direccion_hs'</span>], direccion_vv)</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score <span class="op">&gt;=</span> <span class="dv">70</span>:</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>                <span class="cf">return</span> row[<span class="st">'civ_sugerido'</span>]</span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>df_hs_restantes[<span class="st">'civ'</span>] <span class="op">=</span> df_hs_restantes.<span class="bu">apply</span>(aplicar_civ_vv, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Añadir DIRECCION_VV PARA COMPARAR</span></span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados <span class="op">=</span> df_hs_restantes[df_hs_restantes[<span class="st">'civ'</span>].notna()].copy()</span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados[<span class="st">'direccion_vv'</span>] <span class="op">=</span> df_vv.loc[df_fuzzy_asignados[<span class="st">'indice_vv'</span>], <span class="st">'direccion_vv'</span>].values</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados.index, <span class="st">'direccion_vv'</span>] <span class="op">=</span> df_fuzzy_asignados[<span class="st">'direccion_vv'</span>]</span>
<span id="cb7-39"><a href="#cb7-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-40"><a href="#cb7-40" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegurar que existe la columna 'srid' en df_hs</span></span>
<span id="cb7-41"><a href="#cb7-41" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'srid'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb7-42"><a href="#cb7-42" aria-hidden="true" tabindex="-1"></a>    df_hs[<span class="st">'srid'</span>] <span class="op">=</span> pd.NA</span>
<span id="cb7-43"><a href="#cb7-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-44"><a href="#cb7-44" aria-hidden="true" tabindex="-1"></a><span class="co"># Rellenar columna con info de método y fuente</span></span>
<span id="cb7-45"><a href="#cb7-45" aria-hidden="true" tabindex="-1"></a>fuzzy_indices <span class="op">=</span> df_hs_restantes[df_hs_restantes[<span class="st">'civ'</span>].notna()].index</span>
<span id="cb7-46"><a href="#cb7-46" aria-hidden="true" tabindex="-1"></a>df_hs.loc[fuzzy_indices, <span class="st">'civ'</span>] <span class="op">=</span> df_hs_restantes.loc[fuzzy_indices, <span class="st">'civ'</span>]</span>
<span id="cb7-47"><a href="#cb7-47" aria-hidden="true" tabindex="-1"></a>df_hs.loc[fuzzy_indices, <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'fuzzy - vv'</span></span>
<span id="cb7-48"><a href="#cb7-48" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs_restantes.index, <span class="st">'similitud_vv'</span>] <span class="op">=</span> df_hs_restantes[<span class="st">'similitud_vv'</span>]</span>
<span id="cb7-49"><a href="#cb7-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-50"><a href="#cb7-50" aria-hidden="true" tabindex="-1"></a><span class="co"># Coordenadas desde df_vv usando indice_vv</span></span>
<span id="cb7-51"><a href="#cb7-51" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados[<span class="st">'coor_x'</span>] <span class="op">=</span> df_vv.loc[df_fuzzy_asignados[<span class="st">'indice_vv'</span>], <span class="st">'coor_x'</span>].values</span>
<span id="cb7-52"><a href="#cb7-52" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados[<span class="st">'coor_y'</span>] <span class="op">=</span> df_vv.loc[df_fuzzy_asignados[<span class="st">'indice_vv'</span>], <span class="st">'coor_y'</span>].values</span>
<span id="cb7-53"><a href="#cb7-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-54"><a href="#cb7-54" aria-hidden="true" tabindex="-1"></a><span class="co"># SRID desde df_vv usando indice_vv</span></span>
<span id="cb7-55"><a href="#cb7-55" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados[<span class="st">'srid'</span>] <span class="op">=</span> df_vv.loc[df_fuzzy_asignados[<span class="st">'indice_vv'</span>], <span class="st">'srid'</span>].values</span>
<span id="cb7-56"><a href="#cb7-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-57"><a href="#cb7-57" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignar al df_hs principal</span></span>
<span id="cb7-58"><a href="#cb7-58" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados.index, <span class="st">'coor_x'</span>] <span class="op">=</span> df_fuzzy_asignados[<span class="st">'coor_x'</span>]</span>
<span id="cb7-59"><a href="#cb7-59" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados.index, <span class="st">'coor_y'</span>] <span class="op">=</span> df_fuzzy_asignados[<span class="st">'coor_y'</span>]</span>
<span id="cb7-60"><a href="#cb7-60" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados.index, <span class="st">'srid'</span>] <span class="op">=</span> df_fuzzy_asignados[<span class="st">'srid'</span>]</span>
<span id="cb7-61"><a href="#cb7-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-62"><a href="#cb7-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Finalizar</span></span>
<span id="cb7-63"><a href="#cb7-63" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs_restantes.index, <span class="st">'civ'</span>] <span class="op">=</span> df_hs_restantes[<span class="st">'civ'</span>]</span>
<span id="cb7-64"><a href="#cb7-64" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs_restantes.index, <span class="st">'similitud_vv'</span>] <span class="op">=</span> df_hs_restantes[<span class="st">'similitud_vv'</span>]</span>
<span id="cb7-65"><a href="#cb7-65" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-66"><a href="#cb7-66" aria-hidden="true" tabindex="-1"></a>df_final <span class="op">=</span> df_hs.copy()</span>
<span id="cb7-67"><a href="#cb7-67" aria-hidden="true" tabindex="-1"></a>df_actualizados <span class="op">=</span> df_final[df_final[<span class="st">'civ'</span>].notnull()].copy()</span>
<span id="cb7-68"><a href="#cb7-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-69"><a href="#cb7-69" aria-hidden="true" tabindex="-1"></a><span class="co"># Exportar</span></span>
<span id="cb7-70"><a href="#cb7-70" aria-hidden="true" tabindex="-1"></a><span class="co">#df_final.to_excel('hs_contra_vv_fuzzy_completo.xlsx', index=False)</span></span>
<span id="cb7-71"><a href="#cb7-71" aria-hidden="true" tabindex="-1"></a>df_actualizados.to_excel(<span class="st">'hs_contra_vv_fuzzy_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb7-72"><a href="#cb7-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-73"><a href="#cb7-73" aria-hidden="true" tabindex="-1"></a><span class="co"># Resumen</span></span>
<span id="cb7-74"><a href="#cb7-74" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">len</span>(df_final)</span>
<span id="cb7-75"><a href="#cb7-75" aria-hidden="true" tabindex="-1"></a>asignados_fuzzy <span class="op">=</span> df_hs_restantes[<span class="st">'civ'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb7-76"><a href="#cb7-76" aria-hidden="true" tabindex="-1"></a>acumulado_total <span class="op">=</span> asignados_exacto <span class="op">+</span> asignados_fuzzy</span>
<span id="cb7-77"><a href="#cb7-77" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-78"><a href="#cb7-78" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb7-79"><a href="#cb7-79" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== HS CONTRA VV FUZZY ==="</span>)</span>
<span id="cb7-80"><a href="#cb7-80" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros HS: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-81"><a href="#cb7-81" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por fuzzy matching contra vv: </span><span class="sc">{</span>asignados_fuzzy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb7-82"><a href="#cb7-82" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Porcentaje de coincidencia fuzzy: </span><span class="sc">{</span>(asignados_fuzzy <span class="op">/</span> total) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%"</span>)</span>
<span id="cb7-83"><a href="#cb7-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total CIV completados: </span><span class="sc">{</span>acumulado_total<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(acumulado_total <span class="op">/</span> total) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb7-84"><a href="#cb7-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Archivos generados:"</span>)</span>
<span id="cb7-85"><a href="#cb7-85" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_vv_fuzzy_completo.xlsx"</span>)</span>
<span id="cb7-86"><a href="#cb7-86" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_vv_fuzzy_con_civ.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---catastro-match-exacto" class="level3" data-number="2.3.3">
<h3 data-number="2.3.3" class="anchored" data-anchor-id="hs---catastro-match-exacto"><span class="header-section-number">2.3.3</span> HS - Catastro (match exacto)</h3>
<div id="9bb7e967" class="cell" data-collapse="true" data-execution_count="11">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA FINCA (MATCH EXACTO) ===</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Leer tabla catastro.finca</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>query_finca <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT id_codigo_municipio_dgc, id_parcela_catastral, tipo_via, nombre_via, numero</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="st">FROM catastro.finca</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>df_finca <span class="op">=</span> pd.read_sql(query_finca, engine)</span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Leer tabla parcela para obtener coordenadas</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>query_parcela <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a><span class="st">    refcat,</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a><span class="st">    ST_X(ST_PointOnSurface(geom)) AS coor_x,</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="st">    ST_Y(ST_PointOnSurface(geom)) AS coor_y,</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="st">    ST_SRID(geom) AS srid</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a><span class="st">FROM catastro.parcela</span></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>df_parcela <span class="op">=</span> pd.read_sql(query_parcela, engine)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Normalizar dirección de finca</span></span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>df_finca[<span class="st">'direccion_finca'</span>] <span class="op">=</span> df_finca.<span class="bu">apply</span>(</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'id_codigo_municipio_dgc'</span>], row[<span class="st">'tipo_via'</span>], row[<span class="st">'nombre_via'</span>], row[<span class="st">'numero'</span>]</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Unir finca con parcela (coordenadas)</span></span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>df_finca_coords <span class="op">=</span> df_finca.merge(</span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>    df_parcela, left_on<span class="op">=</span><span class="st">'id_parcela_catastral'</span>, right_on<span class="op">=</span><span class="st">'refcat'</span>, how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a><span class="co"># Agrupar df_finca_coords para conservar solo UNA finca por dirección</span></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a>df_finca_coords_unicos <span class="op">=</span> (</span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a>    df_finca_coords</span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a>    .sort_values(<span class="st">'id_parcela_catastral'</span>)  <span class="co"># o cualquier criterio preferido</span></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>    .drop_duplicates(subset<span class="op">=</span>[<span class="st">'direccion_finca'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Preparar df_hs para merge</span></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a>df_hs_reset <span class="op">=</span> df_hs.reset_index()</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminar posibles columnas de coordenadas previas en df_hs_reset para evitar sufijos</span></span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>df_hs_reset <span class="op">=</span> df_hs_reset.drop(columns<span class="op">=</span>[<span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>], errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co"># Merge con finca</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a>df_hs_finca <span class="op">=</span> df_hs_reset.merge(</span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a>    df_finca_coords_unicos[[<span class="st">'direccion_finca'</span>, <span class="st">'id_parcela_catastral'</span>, <span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]],</span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'direccion_hs'</span>,</span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'direccion_finca'</span>,</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Para evitar asignar CIV finca a varios hogares con la misma dirección:</span></span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a><span class="co"># Crear columna de dirección normalizada en hogares si no existe (usar direccion_hs)</span></span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>df_hs_finca[<span class="st">'direccion_hs_norm'</span>] <span class="op">=</span> df_hs_finca[<span class="st">'direccion_hs'</span>]</span>
<span id="cb8-57"><a href="#cb8-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-58"><a href="#cb8-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Quedarse con un único hogar por dirección para asignar CIV finca</span></span>
<span id="cb8-59"><a href="#cb8-59" aria-hidden="true" tabindex="-1"></a>df_hs_finca_unicos <span class="op">=</span> df_hs_finca.drop_duplicates(subset<span class="op">=</span>[<span class="st">'direccion_hs_norm'</span>], keep<span class="op">=</span><span class="st">'first'</span>)</span>
<span id="cb8-60"><a href="#cb8-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-61"><a href="#cb8-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Definir máscara: hogares sin CIV pero con match exacto a finca (únicos)</span></span>
<span id="cb8-62"><a href="#cb8-62" aria-hidden="true" tabindex="-1"></a>mask_finca <span class="op">=</span> df_hs_finca_unicos[<span class="st">'id_parcela_catastral'</span>].notna() <span class="op">&amp;</span> df_hs_finca_unicos[<span class="st">'civ'</span>].isna()</span>
<span id="cb8-63"><a href="#cb8-63" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-64"><a href="#cb8-64" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Asegurar columnas necesarias en df_hs</span></span>
<span id="cb8-65"><a href="#cb8-65" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'civ'</span>, <span class="st">'metodo-fuente'</span>, <span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]:</span>
<span id="cb8-66"><a href="#cb8-66" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb8-67"><a href="#cb8-67" aria-hidden="true" tabindex="-1"></a>        df_hs[col] <span class="op">=</span> pd.NA</span>
<span id="cb8-68"><a href="#cb8-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-69"><a href="#cb8-69" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Extraer datos actualizables desde df_hs_finca_unicos</span></span>
<span id="cb8-70"><a href="#cb8-70" aria-hidden="true" tabindex="-1"></a>df_to_update <span class="op">=</span> df_hs_finca_unicos.loc[mask_finca, [<span class="st">'index'</span>, <span class="st">'id_parcela_catastral'</span>, <span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]].copy()</span>
<span id="cb8-71"><a href="#cb8-71" aria-hidden="true" tabindex="-1"></a>df_to_update[<span class="st">'civ'</span>] <span class="op">=</span> df_to_update[<span class="st">'id_parcela_catastral'</span>]</span>
<span id="cb8-72"><a href="#cb8-72" aria-hidden="true" tabindex="-1"></a>df_to_update[<span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'match exacto - finca'</span></span>
<span id="cb8-73"><a href="#cb8-73" aria-hidden="true" tabindex="-1"></a>df_to_update <span class="op">=</span> df_to_update[[<span class="st">'index'</span>, <span class="st">'civ'</span>, <span class="st">'metodo-fuente'</span>, <span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]]</span>
<span id="cb8-74"><a href="#cb8-74" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-75"><a href="#cb8-75" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Actualizar df_hs usando índice</span></span>
<span id="cb8-76"><a href="#cb8-76" aria-hidden="true" tabindex="-1"></a>df_to_update.set_index(<span class="st">'index'</span>, inplace<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb8-77"><a href="#cb8-77" aria-hidden="true" tabindex="-1"></a>df_hs.update(df_to_update)</span>
<span id="cb8-78"><a href="#cb8-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-79"><a href="#cb8-79" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Añadir direccion_finca solo a los que se les asignó CIV</span></span>
<span id="cb8-80"><a href="#cb8-80" aria-hidden="true" tabindex="-1"></a>df_hs_asignados_finca <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - finca'</span>].copy()</span>
<span id="cb8-81"><a href="#cb8-81" aria-hidden="true" tabindex="-1"></a>df_hs_asignados_finca[<span class="st">'direccion_finca'</span>] <span class="op">=</span> df_hs_asignados_finca[<span class="st">'direccion_hs'</span>]</span>
<span id="cb8-82"><a href="#cb8-82" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_hs_asignados_finca.index, <span class="st">'direccion_finca'</span>] <span class="op">=</span> df_hs_asignados_finca[<span class="st">'direccion_finca'</span>]</span>
<span id="cb8-83"><a href="#cb8-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-84"><a href="#cb8-84" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Exportar archivos</span></span>
<span id="cb8-85"><a href="#cb8-85" aria-hidden="true" tabindex="-1"></a><span class="co">#df_hs.to_excel('hs_contra_finca_exacto_completo.xlsx', index=False)</span></span>
<span id="cb8-86"><a href="#cb8-86" aria-hidden="true" tabindex="-1"></a>df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - finca'</span>].to_excel(<span class="st">'hs_contra_finca_exacto_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb8-87"><a href="#cb8-87" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-88"><a href="#cb8-88" aria-hidden="true" tabindex="-1"></a><span class="co"># 13. Mostrar resumen</span></span>
<span id="cb8-89"><a href="#cb8-89" aria-hidden="true" tabindex="-1"></a>total <span class="op">=</span> <span class="bu">len</span>(df_hs)</span>
<span id="cb8-90"><a href="#cb8-90" aria-hidden="true" tabindex="-1"></a>completados_fuzzy <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'fuzzy - vv'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb8-91"><a href="#cb8-91" aria-hidden="true" tabindex="-1"></a>completados_exacto_vv <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - vv'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb8-92"><a href="#cb8-92" aria-hidden="true" tabindex="-1"></a>completados_finca <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - finca'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb8-93"><a href="#cb8-93" aria-hidden="true" tabindex="-1"></a>completados_total <span class="op">=</span> df_hs[<span class="st">'civ'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb8-94"><a href="#cb8-94" aria-hidden="true" tabindex="-1"></a>porcentaje <span class="op">=</span> (completados_total <span class="op">/</span> total) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> total <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb8-95"><a href="#cb8-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-96"><a href="#cb8-96" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb8-97"><a href="#cb8-97" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== HS CONTRA FINCA (MATCH EXACTO) ==="</span>)</span>
<span id="cb8-98"><a href="#cb8-98" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros HS: </span><span class="sc">{</span>total<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-99"><a href="#cb8-99" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por coincidencia exacta contra VV: </span><span class="sc">{</span>completados_exacto_vv<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-100"><a href="#cb8-100" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por fuzzy matching contra VV: </span><span class="sc">{</span>completados_fuzzy<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-101"><a href="#cb8-101" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por coincidencia exacta contra finca: </span><span class="sc">{</span>completados_finca<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb8-102"><a href="#cb8-102" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total CIV completados: </span><span class="sc">{</span>completados_total<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>porcentaje<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb8-103"><a href="#cb8-103" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Archivos generados:"</span>)</span>
<span id="cb8-104"><a href="#cb8-104" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_finca_exacto_completo.xlsx"</span>)</span>
<span id="cb8-105"><a href="#cb8-105" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_finca_exacto_con_civ.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---callejero-sitcan-match-exacto-por-código-de-vía" class="level3" data-number="2.3.4">
<h3 data-number="2.3.4" class="anchored" data-anchor-id="hs---callejero-sitcan-match-exacto-por-código-de-vía"><span class="header-section-number">2.3.4</span> HS - Callejero SITCAN (match exacto por código de vía)</h3>
<div id="d50ccfae" class="cell" data-collapse="true" data-execution_count="12">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA CALLEJERO (MATCH EXACTO POR CODVIA) ===</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Leer callejero con geometría y campos para dirección</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT codmun, codvia, tipovia, nombrevia, portal, geom FROM grafcan.callejero_num"</span>,</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia[<span class="st">'srid'</span>] <span class="op">=</span> df_callejero_codvia.crs.to_epsg()</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia[<span class="st">'direccion_callejero'</span>] <span class="op">=</span> df_callejero_codvia.<span class="bu">apply</span>(</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(row[<span class="st">'codmun'</span>]).zfill(<span class="dv">5</span>)[<span class="op">-</span><span class="dv">2</span>:],  <span class="co"># últimos 2 dígitos del municipio</span></span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'tipovia'</span>],                    <span class="co"># tipo de vía (ej: 'Calle')</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'nombrevia'</span>],                  <span class="co"># nombre de la vía (ej: 'Real')</span></span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'portal'</span>]                      <span class="co"># número</span></span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Leer parcelas catastrales con geometría</span></span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT refcat, geom FROM catastro.parcela"</span>,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Filtrar registros sin CIV</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>df_hs_codvia <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].isna()].copy()</span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[Match exacto - codvia] Registros HS sin CIV antes del match: </span><span class="sc">{</span><span class="bu">len</span>(df_hs_codvia)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Homogeneizar claves</span></span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>df_hs_codvia[<span class="st">'cmun_str'</span>] <span class="op">=</span> df_hs_codvia[<span class="st">'cmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:]</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia[<span class="st">'codmun_str'</span>] <span class="op">=</span> df_callejero_codvia[<span class="st">'codmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:]</span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>df_hs_codvia[<span class="st">'cvia_str'</span>] <span class="op">=</span> df_hs_codvia[<span class="st">'cvia'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>)</span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia[<span class="st">'codvia_str'</span>] <span class="op">=</span> df_callejero_codvia[<span class="st">'codvia'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>)</span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>df_hs_codvia[<span class="st">'numer_str'</span>] <span class="op">=</span> df_hs_codvia[<span class="st">'numer'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lstrip(<span class="st">'0'</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia[<span class="st">'portal_str'</span>] <span class="op">=</span> df_callejero_codvia[<span class="st">'portal'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.lstrip(<span class="st">'0'</span>)</span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a><span class="co"># 4.1 Crear columnas para comparación de concatenados codvia</span></span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>df_hs_codvia[<span class="st">'concat_codvia_hs'</span>] <span class="op">=</span> (</span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    df_hs_codvia[<span class="st">'cmun_str'</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> df_hs_codvia[<span class="st">'cvia_str'</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> df_hs_codvia[<span class="st">'numer_str'</span>]</span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>df_callejero_codvia[<span class="st">'concat_codvia_callejero'</span>] <span class="op">=</span> (</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    df_callejero_codvia[<span class="st">'codmun_str'</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> df_callejero_codvia[<span class="st">'codvia_str'</span>] <span class="op">+</span> <span class="st">" "</span> <span class="op">+</span> df_callejero_codvia[<span class="st">'portal_str'</span>]</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Join exacto</span></span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>df_hs_codvia[<span class="st">'index_hs'</span>] <span class="op">=</span> df_hs_codvia.index</span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>df_join <span class="op">=</span> df_hs_codvia.merge(</span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    df_callejero_codvia,</span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span>[<span class="st">'cmun_str'</span>, <span class="st">'cvia_str'</span>, <span class="st">'numer_str'</span>],</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span>[<span class="st">'codmun_str'</span>, <span class="st">'codvia_str'</span>, <span class="st">'portal_str'</span>],</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span>,</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    suffixes<span class="op">=</span>(<span class="st">'_hs'</span>, <span class="st">'_call'</span>)</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[Match exacto - codvia] Coincidencias exactas encontradas: </span><span class="sc">{</span>df_join<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Asignar direccion_callejero a df_hs usando merge seguro</span></span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'direccion_callejero'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    df_hs[<span class="st">'direccion_callejero'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignar con base en índice original</span></span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df_join.iterrows():</span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    ix <span class="op">=</span> row[<span class="st">'index_hs'</span>]</span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    df_hs.at[ix, <span class="st">'direccion_callejero'</span>] <span class="op">=</span> row[<span class="st">'direccion_callejero'</span>]</span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Generar puntos a partir de geometría del callejero</span></span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>df_join[<span class="st">'punto'</span>] <span class="op">=</span> df_join[<span class="st">'geom'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> g: g.centroid <span class="cf">if</span> g <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Crear GeoDataFrame para join espacial</span></span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>gdf_join <span class="op">=</span> gpd.GeoDataFrame(df_join, geometry<span class="op">=</span><span class="st">'punto'</span>, crs<span class="op">=</span>df_callejero_codvia.crs)</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegurar que ambos están en mismo CRS</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gdf_parcelas.to_crs(gdf_join.crs)</span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Join espacial</span></span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gpd.sjoin(</span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>    gdf_join,</span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>    gdf_parcelas[[<span class="st">'refcat'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    predicate<span class="op">=</span><span class="st">'within'</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gdf_joined.rename(columns<span class="op">=</span>{<span class="st">'geom'</span>: <span class="st">'geom_parcela'</span>})</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gdf_joined.set_geometry(<span class="st">'geom_parcela'</span>)</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Extraer info y actualizar df_hs</span></span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'coor_x'</span>] <span class="op">=</span> gdf_joined[<span class="st">'punto'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.x <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'coor_y'</span>] <span class="op">=</span> gdf_joined[<span class="st">'punto'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.y <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'srid'</span>] <span class="op">=</span> gdf_joined.crs.to_epsg()</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> gdf_joined.iterrows():</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>    ix <span class="op">=</span> row[<span class="st">'index_hs'</span>] </span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.notna(row[<span class="st">'refcat'</span>]):</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'civ'</span>] <span class="op">=</span> row[<span class="st">'refcat'</span>]</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'match exacto - codvia callejero'</span></span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_x'</span>] <span class="op">=</span> row[<span class="st">'coor_x'</span>]</span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_y'</span>] <span class="op">=</span> row[<span class="st">'coor_y'</span>]</span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'srid'</span>] <span class="op">=</span> row[<span class="st">'srid'</span>]</span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'concat_codvia_hs'</span>] <span class="op">=</span> row[<span class="st">'concat_codvia_hs'</span>]</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'concat_codvia_callejero'</span>] <span class="op">=</span> row[<span class="st">'concat_codvia_callejero'</span>]</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Exportar resultados</span></span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a><span class="co">#df_hs.to_excel("hs_contra_callejero_codvia_completo.xlsx", index=False)</span></span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>df_hs[df_hs[<span class="st">'civ'</span>].notna()].to_excel(<span class="st">"hs_contra_callejero_codvia_con_civ.xlsx"</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Print resumen</span></span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== HS CONTRA CALLEJERO - MATCH EXACTO POR CODVIA ==="</span>)</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros en df_hs: </span><span class="sc">{</span><span class="bu">len</span>(df_hs)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total CIV completados: </span><span class="sc">{</span>df_hs[<span class="st">'civ'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(df_hs[<span class="st">'civ'</span>].notna().mean() <span class="op">*</span> <span class="dv">100</span>)<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total CIV recuperados por codvia: </span><span class="sc">{</span>(df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - codvia callejero'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total pendientes (sin CIV): </span><span class="sc">{</span>df_hs[<span class="st">'civ'</span>]<span class="sc">.</span>isna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(df_hs[<span class="st">'civ'</span>].isna().mean() <span class="op">*</span> <span class="dv">100</span>)<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---catastro-fuzzy-match" class="level3" data-number="2.3.5">
<h3 data-number="2.3.5" class="anchored" data-anchor-id="hs---catastro-fuzzy-match"><span class="header-section-number">2.3.5</span> HS - Catastro (fuzzy match)</h3>
<div id="ad03a537" class="cell" data-collapse="true" data-execution_count="13">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA FINCA (FUZZY MATCHING)  ===</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>vectorizer_finca <span class="op">=</span> TfidfVectorizer(analyzer<span class="op">=</span><span class="st">'char_wb'</span>, ngram_range<span class="op">=</span>(<span class="dv">3</span>, <span class="dv">5</span>))</span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Filtrar registros HS que aún no tienen CIV asignado (tras exacto y fuzzy VV)</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>df_sin_civ <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].isna()].copy()</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Guardar el índice del vecino más cercano por vectorizado</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>tfidf_finca <span class="op">=</span> vectorizer_finca.fit_transform(df_finca[<span class="st">'direccion_finca'</span>].fillna(<span class="st">''</span>))</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>tfidf_hs_sin_civ <span class="op">=</span> vectorizer_finca.transform(df_sin_civ[<span class="st">'direccion_hs'</span>].fillna(<span class="st">''</span>))</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>nn_finca <span class="op">=</span> NearestNeighbors(n_neighbors<span class="op">=</span><span class="dv">1</span>, metric<span class="op">=</span><span class="st">'cosine'</span>).fit(tfidf_finca)</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>_, indices_finca <span class="op">=</span> nn_finca.kneighbors(tfidf_hs_sin_civ)</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>df_sin_civ[<span class="st">'indice_finca'</span>] <span class="op">=</span> indices_finca.flatten()</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Función principal para fuzzy matching con score</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzzy_finca(row):</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>        finca_row <span class="op">=</span> df_finca.iloc[row[<span class="st">'indice_finca'</span>]]</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>        direccion_finca <span class="op">=</span> finca_row[<span class="st">'direccion_finca'</span>]</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>        score <span class="op">=</span> fuzz.token_set_ratio(row[<span class="st">'direccion_hs'</span>], direccion_finca)</span>
<span id="cb10-21"><a href="#cb10-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-22"><a href="#cb10-22" aria-hidden="true" tabindex="-1"></a>        num_hs <span class="op">=</span> <span class="bu">int</span>(<span class="bu">str</span>(row[<span class="st">'numer'</span>]).lstrip(<span class="st">'0'</span>) <span class="kw">or</span> <span class="st">'0'</span>)</span>
<span id="cb10-23"><a href="#cb10-23" aria-hidden="true" tabindex="-1"></a>        num_finca <span class="op">=</span> <span class="bu">int</span>(<span class="bu">str</span>(finca_row[<span class="st">'numero'</span>]).lstrip(<span class="st">'0'</span>) <span class="kw">or</span> <span class="st">'0'</span>)</span>
<span id="cb10-24"><a href="#cb10-24" aria-hidden="true" tabindex="-1"></a>        municipio_hs <span class="op">=</span> <span class="bu">str</span>(row[<span class="st">'cmun'</span>]).strip()</span>
<span id="cb10-25"><a href="#cb10-25" aria-hidden="true" tabindex="-1"></a>        municipio_finca <span class="op">=</span> <span class="bu">str</span>(finca_row[<span class="st">'id_codigo_municipio_dgc'</span>]).strip()</span>
<span id="cb10-26"><a href="#cb10-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-27"><a href="#cb10-27" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> score <span class="op">&gt;=</span> <span class="dv">70</span> <span class="kw">and</span> num_hs <span class="op">==</span> num_finca <span class="kw">and</span> municipio_hs <span class="op">==</span> municipio_finca:</span>
<span id="cb10-28"><a href="#cb10-28" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'score_finca'</span>] <span class="op">=</span> score</span>
<span id="cb10-29"><a href="#cb10-29" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> pd.Series([finca_row[<span class="st">'id_parcela_catastral'</span>], score])</span>
<span id="cb10-30"><a href="#cb10-30" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span> <span class="pp">Exception</span>:</span>
<span id="cb10-31"><a href="#cb10-31" aria-hidden="true" tabindex="-1"></a>        <span class="cf">pass</span></span>
<span id="cb10-32"><a href="#cb10-32" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> pd.Series([<span class="va">None</span>, <span class="va">None</span>])</span>
<span id="cb10-33"><a href="#cb10-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-34"><a href="#cb10-34" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Aplicar fuzzy_finca y guardar score directamente</span></span>
<span id="cb10-35"><a href="#cb10-35" aria-hidden="true" tabindex="-1"></a>df_sin_civ[[<span class="st">'civ'</span>, <span class="st">'score_finca'</span>]] <span class="op">=</span> df_sin_civ.<span class="bu">apply</span>(fuzzy_finca, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb10-36"><a href="#cb10-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-37"><a href="#cb10-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Actualizar df_hs solo con los que tienen civ asignado</span></span>
<span id="cb10-38"><a href="#cb10-38" aria-hidden="true" tabindex="-1"></a>indices_sin_civ <span class="op">=</span> df_sin_civ.index</span>
<span id="cb10-39"><a href="#cb10-39" aria-hidden="true" tabindex="-1"></a>mask_fuzzy_finca <span class="op">=</span> df_sin_civ[<span class="st">'civ'</span>].notna()</span>
<span id="cb10-40"><a href="#cb10-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-41"><a href="#cb10-41" aria-hidden="true" tabindex="-1"></a>df_hs.loc[indices_sin_civ[mask_fuzzy_finca], <span class="st">'civ'</span>] <span class="op">=</span> df_sin_civ.loc[mask_fuzzy_finca, <span class="st">'civ'</span>]</span>
<span id="cb10-42"><a href="#cb10-42" aria-hidden="true" tabindex="-1"></a>df_hs.loc[indices_sin_civ[mask_fuzzy_finca], <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'fuzzy - finca'</span></span>
<span id="cb10-43"><a href="#cb10-43" aria-hidden="true" tabindex="-1"></a>df_hs.loc[indices_sin_civ[mask_fuzzy_finca], <span class="st">'score_finca'</span>] <span class="op">=</span> df_sin_civ.loc[mask_fuzzy_finca, <span class="st">'score_finca'</span>]</span>
<span id="cb10-44"><a href="#cb10-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-45"><a href="#cb10-45" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Añadir la dirección de finca a los asignados</span></span>
<span id="cb10-46"><a href="#cb10-46" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados_finca <span class="op">=</span> df_sin_civ[mask_fuzzy_finca].copy()</span>
<span id="cb10-47"><a href="#cb10-47" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados_finca[<span class="st">'direccion_finca'</span>] <span class="op">=</span> df_finca.loc[df_fuzzy_asignados_finca[<span class="st">'indice_finca'</span>], <span class="st">'direccion_finca'</span>].values</span>
<span id="cb10-48"><a href="#cb10-48" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados_finca.index, <span class="st">'direccion_finca'</span>] <span class="op">=</span> df_fuzzy_asignados_finca[<span class="st">'direccion_finca'</span>]</span>
<span id="cb10-49"><a href="#cb10-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-50"><a href="#cb10-50" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Eliminar coordenadas preexistentes para evitar conflictos</span></span>
<span id="cb10-51"><a href="#cb10-51" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados_finca <span class="op">=</span> df_fuzzy_asignados_finca.drop(columns<span class="op">=</span>[<span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>, <span class="st">'refcat'</span>], errors<span class="op">=</span><span class="st">'ignore'</span>)</span>
<span id="cb10-52"><a href="#cb10-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-53"><a href="#cb10-53" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar índice original antes del merge para mantener la referencia a df_hs</span></span>
<span id="cb10-54"><a href="#cb10-54" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados_finca <span class="op">=</span> df_fuzzy_asignados_finca.reset_index()</span>
<span id="cb10-55"><a href="#cb10-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-56"><a href="#cb10-56" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Merge con df_parcela para obtener coordenadas (punto dentro de la parcela)</span></span>
<span id="cb10-57"><a href="#cb10-57" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados_finca <span class="op">=</span> df_fuzzy_asignados_finca.merge(</span>
<span id="cb10-58"><a href="#cb10-58" aria-hidden="true" tabindex="-1"></a>    df_parcela[[<span class="st">'refcat'</span>, <span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]],</span>
<span id="cb10-59"><a href="#cb10-59" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'civ'</span>, right_on<span class="op">=</span><span class="st">'refcat'</span>, how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb10-60"><a href="#cb10-60" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb10-61"><a href="#cb10-61" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-62"><a href="#cb10-62" aria-hidden="true" tabindex="-1"></a><span class="co"># Restaurar el índice original para la asignación en df_hs</span></span>
<span id="cb10-63"><a href="#cb10-63" aria-hidden="true" tabindex="-1"></a>df_fuzzy_asignados_finca <span class="op">=</span> df_fuzzy_asignados_finca.set_index(<span class="st">'index'</span>)</span>
<span id="cb10-64"><a href="#cb10-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-65"><a href="#cb10-65" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Asignar coordenadas a df_hs para los registros con civ asignado</span></span>
<span id="cb10-66"><a href="#cb10-66" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados_finca.index, <span class="st">'coor_x'</span>] <span class="op">=</span> df_fuzzy_asignados_finca[<span class="st">'coor_x'</span>]</span>
<span id="cb10-67"><a href="#cb10-67" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados_finca.index, <span class="st">'coor_y'</span>] <span class="op">=</span> df_fuzzy_asignados_finca[<span class="st">'coor_y'</span>]</span>
<span id="cb10-68"><a href="#cb10-68" aria-hidden="true" tabindex="-1"></a>df_hs.loc[df_fuzzy_asignados_finca.index, <span class="st">'srid'</span>] <span class="op">=</span> df_fuzzy_asignados_finca[<span class="st">'srid'</span>]</span>
<span id="cb10-69"><a href="#cb10-69" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-70"><a href="#cb10-70" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Guardar archivos finales</span></span>
<span id="cb10-71"><a href="#cb10-71" aria-hidden="true" tabindex="-1"></a><span class="co">#df_hs.to_excel('hs_contra_finca_fuzzy_completo.xlsx', index=False)</span></span>
<span id="cb10-72"><a href="#cb10-72" aria-hidden="true" tabindex="-1"></a>df_hs[df_hs[<span class="st">'civ'</span>].notna()].to_excel(<span class="st">'hs_contra_finca_fuzzy_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb10-73"><a href="#cb10-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-74"><a href="#cb10-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Mostrar resumen</span></span>
<span id="cb10-75"><a href="#cb10-75" aria-hidden="true" tabindex="-1"></a>total_final <span class="op">=</span> <span class="bu">len</span>(df_hs)</span>
<span id="cb10-76"><a href="#cb10-76" aria-hidden="true" tabindex="-1"></a>completados_exacto_vv <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - vv'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb10-77"><a href="#cb10-77" aria-hidden="true" tabindex="-1"></a>completados_fuzzy_vv <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'fuzzy - vv'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb10-78"><a href="#cb10-78" aria-hidden="true" tabindex="-1"></a>completados_exacto_finca <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - finca'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb10-79"><a href="#cb10-79" aria-hidden="true" tabindex="-1"></a>completados_fuzzy_finca <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'fuzzy - finca'</span>].shape[<span class="dv">0</span>]</span>
<span id="cb10-80"><a href="#cb10-80" aria-hidden="true" tabindex="-1"></a>completados_total_final <span class="op">=</span> df_hs[<span class="st">'civ'</span>].notna().<span class="bu">sum</span>()</span>
<span id="cb10-81"><a href="#cb10-81" aria-hidden="true" tabindex="-1"></a>porcentaje_final <span class="op">=</span> (completados_total_final <span class="op">/</span> total_final) <span class="op">*</span> <span class="dv">100</span> <span class="cf">if</span> total_final <span class="op">&gt;</span> <span class="dv">0</span> <span class="cf">else</span> <span class="dv">0</span></span>
<span id="cb10-82"><a href="#cb10-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-83"><a href="#cb10-83" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb10-84"><a href="#cb10-84" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== HS CONTRA FINCA (FUZZY MATCHING) ==="</span>)</span>
<span id="cb10-85"><a href="#cb10-85" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros HS: </span><span class="sc">{</span>total_final<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-86"><a href="#cb10-86" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por coincidencia exacta contra VV: </span><span class="sc">{</span>completados_exacto_vv<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-87"><a href="#cb10-87" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por fuzzy matching contra VV: </span><span class="sc">{</span>completados_fuzzy_vv<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-88"><a href="#cb10-88" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por coincidencia exacta contra finca: </span><span class="sc">{</span>completados_exacto_finca<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-89"><a href="#cb10-89" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados por fuzzy matching contra finca: </span><span class="sc">{</span>completados_fuzzy_finca<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb10-90"><a href="#cb10-90" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total CIV completados: </span><span class="sc">{</span>completados_total_final<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>porcentaje_final<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb10-91"><a href="#cb10-91" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Archivos generados:"</span>)</span>
<span id="cb10-92"><a href="#cb10-92" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_finca_fuzzy_completo.xlsx"</span>)</span>
<span id="cb10-93"><a href="#cb10-93" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">" - hs_contra_finca_fuzzy_con_civ.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---callejero-sitcan-fuzzy-match" class="level3" data-number="2.3.6">
<h3 data-number="2.3.6" class="anchored" data-anchor-id="hs---callejero-sitcan-fuzzy-match"><span class="header-section-number">2.3.6</span> HS - Callejero SITCAN (fuzzy match)</h3>
<div id="79f18663" class="cell" data-collapse="true" data-execution_count="14">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA CALLEJERO (FUZZY MATCHING POR PORTAL) ===</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> normalizar_portal(portal):</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>    texto <span class="op">=</span> <span class="bu">str</span>(portal).strip().upper()</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>    match <span class="op">=</span> re.match(<span class="vs">r'</span><span class="dv">^</span><span class="vs">0</span><span class="op">*</span><span class="kw">(</span><span class="dv">\d</span><span class="op">+</span><span class="kw">)(</span><span class="pp">[A-Z]</span><span class="op">*</span><span class="kw">)</span><span class="dv">$</span><span class="vs">'</span>, texto)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> match:</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        numero <span class="op">=</span> match.group(<span class="dv">1</span>)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        sufijo <span class="op">=</span> match.group(<span class="dv">2</span>)</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> numero <span class="op">+</span> sufijo</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> texto</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Leer callejero (sin geometría) y normalizar dirección</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>query_callejero <span class="op">=</span> <span class="st">"""</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="st">SELECT </span></span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a><span class="st">    codmun, </span></span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a><span class="st">    tipovia, </span></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a><span class="st">    nombrevia, </span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a><span class="st">    portal</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a><span class="st">FROM grafcan.callejero_num</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a><span class="st">"""</span></span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>df_callejero <span class="op">=</span> pd.read_sql(query_callejero, engine)</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>df_callejero[<span class="st">'direccion_callejero'</span>] <span class="op">=</span> df_callejero.<span class="bu">apply</span>(</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(<span class="bu">str</span>(row[<span class="st">'codmun'</span>]).zfill(<span class="dv">5</span>)[<span class="op">-</span><span class="dv">2</span>:], row[<span class="st">'tipovia'</span>], row[<span class="st">'nombrevia'</span>], row[<span class="st">'portal'</span>]),</span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-26"><a href="#cb11-26" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-27"><a href="#cb11-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-28"><a href="#cb11-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Leer parcelas con geometría para crear puntos propios dentro</span></span>
<span id="cb11-29"><a href="#cb11-29" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb11-30"><a href="#cb11-30" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT refcat, geom FROM catastro.parcela"</span>,</span>
<span id="cb11-31"><a href="#cb11-31" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb11-32"><a href="#cb11-32" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb11-33"><a href="#cb11-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-34"><a href="#cb11-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-35"><a href="#cb11-35" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Filtrar registros HS sin civ y normalizar dirección</span></span>
<span id="cb11-36"><a href="#cb11-36" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].isna()].copy()</span>
<span id="cb11-37"><a href="#cb11-37" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ.reset_index(inplace<span class="op">=</span><span class="va">True</span>)  <span class="co"># para mantener índice original en columna 'index'</span></span>
<span id="cb11-38"><a href="#cb11-38" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ[<span class="st">'direccion_hs'</span>] <span class="op">=</span> df_hs_sin_civ.<span class="bu">apply</span>(</span>
<span id="cb11-39"><a href="#cb11-39" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(</span>
<span id="cb11-40"><a href="#cb11-40" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(row[<span class="st">'cmun'</span>]).zfill(<span class="dv">5</span>)[<span class="op">-</span><span class="dv">2</span>:], </span>
<span id="cb11-41"><a href="#cb11-41" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'tvia'</span>], </span>
<span id="cb11-42"><a href="#cb11-42" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'nvia'</span>], </span>
<span id="cb11-43"><a href="#cb11-43" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'numer'</span>],</span>
<span id="cb11-44"><a href="#cb11-44" aria-hidden="true" tabindex="-1"></a>        bloque<span class="op">=</span>row.get(<span class="st">'bloque'</span>),</span>
<span id="cb11-45"><a href="#cb11-45" aria-hidden="true" tabindex="-1"></a>        bloq<span class="op">=</span>row.get(<span class="st">'bloq'</span>),</span>
<span id="cb11-46"><a href="#cb11-46" aria-hidden="true" tabindex="-1"></a>        port<span class="op">=</span>row.get(<span class="st">'port'</span>)</span>
<span id="cb11-47"><a href="#cb11-47" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-48"><a href="#cb11-48" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-49"><a href="#cb11-49" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-50"><a href="#cb11-50" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-51"><a href="#cb11-51" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegurar que la columna score_callejero existe en df_hs para evitar problemas al asignar</span></span>
<span id="cb11-52"><a href="#cb11-52" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'score_callejero'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb11-53"><a href="#cb11-53" aria-hidden="true" tabindex="-1"></a>    df_hs[<span class="st">'score_callejero'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-54"><a href="#cb11-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-55"><a href="#cb11-55" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Agregar municipio para hacer el matching agrupado</span></span>
<span id="cb11-56"><a href="#cb11-56" aria-hidden="true" tabindex="-1"></a><span class="co"># CAMBIO: usar los últimos 2 dígitos en lugar de 3</span></span>
<span id="cb11-57"><a href="#cb11-57" aria-hidden="true" tabindex="-1"></a>df_callejero[<span class="st">'municipio'</span>] <span class="op">=</span> df_callejero[<span class="st">'codmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:]</span>
<span id="cb11-58"><a href="#cb11-58" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ[<span class="st">'municipio'</span>] <span class="op">=</span> df_hs_sin_civ[<span class="st">'cmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:]</span>
<span id="cb11-59"><a href="#cb11-59" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-60"><a href="#cb11-60" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Fuzzy matching</span></span>
<span id="cb11-61"><a href="#cb11-61" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rapidfuzz <span class="im">import</span> process, fuzz</span>
<span id="cb11-62"><a href="#cb11-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-63"><a href="#cb11-63" aria-hidden="true" tabindex="-1"></a>score_cutoff <span class="op">=</span> <span class="dv">80</span></span>
<span id="cb11-64"><a href="#cb11-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-65"><a href="#cb11-65" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzzy_match_callejero(df_hs_sub, df_call_sub, score_cutoff):</span>
<span id="cb11-66"><a href="#cb11-66" aria-hidden="true" tabindex="-1"></a>    resultados <span class="op">=</span> []</span>
<span id="cb11-67"><a href="#cb11-67" aria-hidden="true" tabindex="-1"></a>    call_direcciones <span class="op">=</span> df_call_sub[<span class="st">'direccion_callejero'</span>].tolist()</span>
<span id="cb11-68"><a href="#cb11-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-69"><a href="#cb11-69" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> idx, direccion_hs <span class="kw">in</span> df_hs_sub[<span class="st">'direccion_hs'</span>].items():</span>
<span id="cb11-70"><a href="#cb11-70" aria-hidden="true" tabindex="-1"></a>        res <span class="op">=</span> process.extractOne(direccion_hs, call_direcciones, scorer<span class="op">=</span>fuzz.ratio, score_cutoff<span class="op">=</span>score_cutoff)</span>
<span id="cb11-71"><a href="#cb11-71" aria-hidden="true" tabindex="-1"></a>        </span>
<span id="cb11-72"><a href="#cb11-72" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> res:</span>
<span id="cb11-73"><a href="#cb11-73" aria-hidden="true" tabindex="-1"></a>            matched_str, score, match_pos <span class="op">=</span> res</span>
<span id="cb11-74"><a href="#cb11-74" aria-hidden="true" tabindex="-1"></a>            idx_call <span class="op">=</span> df_call_sub.index[match_pos]</span>
<span id="cb11-75"><a href="#cb11-75" aria-hidden="true" tabindex="-1"></a>            </span>
<span id="cb11-76"><a href="#cb11-76" aria-hidden="true" tabindex="-1"></a>            portal_hs <span class="op">=</span> normalizar_portal(df_hs_sub.at[idx, <span class="st">'numer'</span>])</span>
<span id="cb11-77"><a href="#cb11-77" aria-hidden="true" tabindex="-1"></a>            portal_call <span class="op">=</span> normalizar_portal(df_call_sub.at[idx_call, <span class="st">'portal'</span>])</span>
<span id="cb11-78"><a href="#cb11-78" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-79"><a href="#cb11-79" aria-hidden="true" tabindex="-1"></a>            municipio_hs <span class="op">=</span> <span class="bu">str</span>(df_hs_sub.at[idx, <span class="st">'municipio'</span>]).strip()</span>
<span id="cb11-80"><a href="#cb11-80" aria-hidden="true" tabindex="-1"></a>            municipio_call <span class="op">=</span> <span class="bu">str</span>(df_call_sub.at[idx_call, <span class="st">'municipio'</span>]).strip()</span>
<span id="cb11-81"><a href="#cb11-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-82"><a href="#cb11-82" aria-hidden="true" tabindex="-1"></a>            <span class="cf">if</span> score <span class="op">==</span> <span class="dv">100</span> <span class="kw">and</span> municipio_hs <span class="op">==</span> municipio_call:</span>
<span id="cb11-83"><a href="#cb11-83" aria-hidden="true" tabindex="-1"></a>                resultados.append((idx, matched_str, score, idx_call))</span>
<span id="cb11-84"><a href="#cb11-84" aria-hidden="true" tabindex="-1"></a>            <span class="cf">elif</span> score <span class="op">&gt;=</span> score_cutoff <span class="kw">and</span> portal_hs <span class="op">==</span> portal_call <span class="kw">and</span> municipio_hs <span class="op">==</span> municipio_call:</span>
<span id="cb11-85"><a href="#cb11-85" aria-hidden="true" tabindex="-1"></a>                resultados.append((idx, matched_str, score, idx_call))</span>
<span id="cb11-86"><a href="#cb11-86" aria-hidden="true" tabindex="-1"></a>            <span class="cf">else</span>:</span>
<span id="cb11-87"><a href="#cb11-87" aria-hidden="true" tabindex="-1"></a>                resultados.append((idx, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>))</span>
<span id="cb11-88"><a href="#cb11-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb11-89"><a href="#cb11-89" aria-hidden="true" tabindex="-1"></a>            resultados.append((idx, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>))</span>
<span id="cb11-90"><a href="#cb11-90" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb11-91"><a href="#cb11-91" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> resultados</span>
<span id="cb11-92"><a href="#cb11-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-93"><a href="#cb11-93" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Matching por municipio</span></span>
<span id="cb11-94"><a href="#cb11-94" aria-hidden="true" tabindex="-1"></a>resultados <span class="op">=</span> []</span>
<span id="cb11-95"><a href="#cb11-95" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> muni <span class="kw">in</span> df_hs_sin_civ[<span class="st">'municipio'</span>].unique():</span>
<span id="cb11-96"><a href="#cb11-96" aria-hidden="true" tabindex="-1"></a>    hs_sub <span class="op">=</span> df_hs_sin_civ[df_hs_sin_civ[<span class="st">'municipio'</span>] <span class="op">==</span> muni]</span>
<span id="cb11-97"><a href="#cb11-97" aria-hidden="true" tabindex="-1"></a>    call_sub <span class="op">=</span> df_callejero[df_callejero[<span class="st">'municipio'</span>] <span class="op">==</span> muni]</span>
<span id="cb11-98"><a href="#cb11-98" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> call_sub.empty:</span>
<span id="cb11-99"><a href="#cb11-99" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> idx <span class="kw">in</span> hs_sub.index:</span>
<span id="cb11-100"><a href="#cb11-100" aria-hidden="true" tabindex="-1"></a>            resultados.append((idx, <span class="va">None</span>, <span class="va">None</span>, <span class="va">None</span>))</span>
<span id="cb11-101"><a href="#cb11-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-102"><a href="#cb11-102" aria-hidden="true" tabindex="-1"></a>        resultados.extend(fuzzy_match_callejero(hs_sub, call_sub, score_cutoff))</span>
<span id="cb11-103"><a href="#cb11-103" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-104"><a href="#cb11-104" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Guardar resultados en df_hs_sin_civ</span></span>
<span id="cb11-105"><a href="#cb11-105" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ[<span class="st">'direccion_callejero'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-106"><a href="#cb11-106" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ[<span class="st">'score_callejero'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-107"><a href="#cb11-107" aria-hidden="true" tabindex="-1"></a>df_hs_sin_civ[<span class="st">'idx_callejero'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb11-108"><a href="#cb11-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-109"><a href="#cb11-109" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, match_str, score, idx_call <span class="kw">in</span> resultados:</span>
<span id="cb11-110"><a href="#cb11-110" aria-hidden="true" tabindex="-1"></a>    df_hs_sin_civ.at[idx, <span class="st">'direccion_callejero'</span>] <span class="op">=</span> match_str</span>
<span id="cb11-111"><a href="#cb11-111" aria-hidden="true" tabindex="-1"></a>    df_hs_sin_civ.at[idx, <span class="st">'score_callejero'</span>] <span class="op">=</span> score</span>
<span id="cb11-112"><a href="#cb11-112" aria-hidden="true" tabindex="-1"></a>    df_hs_sin_civ.at[idx, <span class="st">'idx_callejero'</span>] <span class="op">=</span> idx_call</span>
<span id="cb11-113"><a href="#cb11-113" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-114"><a href="#cb11-114" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Filtrar coincidencias y eliminar duplicados manteniendo el mayor score por índice original 'index'</span></span>
<span id="cb11-115"><a href="#cb11-115" aria-hidden="true" tabindex="-1"></a>df_matched <span class="op">=</span> df_hs_sin_civ[df_hs_sin_civ[<span class="st">'direccion_callejero'</span>].notna()].copy()</span>
<span id="cb11-116"><a href="#cb11-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-117"><a href="#cb11-117" aria-hidden="true" tabindex="-1"></a><span class="co"># Eliminar duplicados quedándonos con el de mayor score para cada índice original 'index'</span></span>
<span id="cb11-118"><a href="#cb11-118" aria-hidden="true" tabindex="-1"></a>df_matched <span class="op">=</span> df_matched.sort_values(<span class="st">'score_callejero'</span>, ascending<span class="op">=</span><span class="va">False</span>).drop_duplicates(subset<span class="op">=</span>[<span class="st">'index'</span>])</span>
<span id="cb11-119"><a href="#cb11-119" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-120"><a href="#cb11-120" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Unir con geometría del callejero para obtener info (opcional)</span></span>
<span id="cb11-121"><a href="#cb11-121" aria-hidden="true" tabindex="-1"></a>df_callejero_geom <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb11-122"><a href="#cb11-122" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT codmun, tipovia, nombrevia, portal, geom FROM grafcan.callejero_num"</span>,</span>
<span id="cb11-123"><a href="#cb11-123" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb11-124"><a href="#cb11-124" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb11-125"><a href="#cb11-125" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-126"><a href="#cb11-126" aria-hidden="true" tabindex="-1"></a>df_callejero_geom[<span class="st">'municipio'</span>] <span class="op">=</span> df_callejero_geom[<span class="st">'codmun'</span>].astype(<span class="bu">str</span>).<span class="bu">str</span>.zfill(<span class="dv">5</span>).<span class="bu">str</span>[<span class="op">-</span><span class="dv">2</span>:]</span>
<span id="cb11-127"><a href="#cb11-127" aria-hidden="true" tabindex="-1"></a>df_callejero_geom[<span class="st">'direccion_callejero'</span>] <span class="op">=</span> df_callejero_geom.<span class="bu">apply</span>(</span>
<span id="cb11-128"><a href="#cb11-128" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(row[<span class="st">'municipio'</span>], row[<span class="st">'tipovia'</span>], row[<span class="st">'nombrevia'</span>], row[<span class="st">'portal'</span>]),</span>
<span id="cb11-129"><a href="#cb11-129" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span></span>
<span id="cb11-130"><a href="#cb11-130" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-131"><a href="#cb11-131" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-132"><a href="#cb11-132" aria-hidden="true" tabindex="-1"></a>df_matched <span class="op">=</span> df_matched.merge(</span>
<span id="cb11-133"><a href="#cb11-133" aria-hidden="true" tabindex="-1"></a>    df_callejero_geom[[<span class="st">'direccion_callejero'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb11-134"><a href="#cb11-134" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">'direccion_callejero'</span>,</span>
<span id="cb11-135"><a href="#cb11-135" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb11-136"><a href="#cb11-136" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-137"><a href="#cb11-137" aria-hidden="true" tabindex="-1"></a>gdf_matched <span class="op">=</span> gpd.GeoDataFrame(df_matched, geometry<span class="op">=</span><span class="st">'geom'</span>, crs<span class="op">=</span>df_callejero_geom.crs)</span>
<span id="cb11-138"><a href="#cb11-138" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-139"><a href="#cb11-139" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-140"><a href="#cb11-140" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Join espacial con parcelas para obtener refcat</span></span>
<span id="cb11-141"><a href="#cb11-141" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gdf_parcelas.to_crs(gdf_matched.crs)</span>
<span id="cb11-142"><a href="#cb11-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-143"><a href="#cb11-143" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gpd.sjoin(</span>
<span id="cb11-144"><a href="#cb11-144" aria-hidden="true" tabindex="-1"></a>    gdf_matched,</span>
<span id="cb11-145"><a href="#cb11-145" aria-hidden="true" tabindex="-1"></a>    gdf_parcelas[[<span class="st">'refcat'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb11-146"><a href="#cb11-146" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb11-147"><a href="#cb11-147" aria-hidden="true" tabindex="-1"></a>    predicate<span class="op">=</span><span class="st">'within'</span></span>
<span id="cb11-148"><a href="#cb11-148" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-149"><a href="#cb11-149" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-150"><a href="#cb11-150" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gdf_joined.rename(columns<span class="op">=</span>{<span class="st">'geom'</span>: <span class="st">'geom_parcela'</span>})</span>
<span id="cb11-151"><a href="#cb11-151" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gdf_joined.set_geometry(<span class="st">'geom_parcela'</span>)</span>
<span id="cb11-152"><a href="#cb11-152" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-153"><a href="#cb11-153" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Crear punto propio dentro de la parcela</span></span>
<span id="cb11-154"><a href="#cb11-154" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> shapely.geometry <span class="im">import</span> Point</span>
<span id="cb11-155"><a href="#cb11-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-156"><a href="#cb11-156" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> crear_punto_dentro(geom_parcela):</span>
<span id="cb11-157"><a href="#cb11-157" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> geom_parcela <span class="kw">is</span> <span class="va">None</span> <span class="kw">or</span> geom_parcela.is_empty:</span>
<span id="cb11-158"><a href="#cb11-158" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">None</span></span>
<span id="cb11-159"><a href="#cb11-159" aria-hidden="true" tabindex="-1"></a>    centroide <span class="op">=</span> geom_parcela.centroid</span>
<span id="cb11-160"><a href="#cb11-160" aria-hidden="true" tabindex="-1"></a>    punto_mod <span class="op">=</span> Point(centroide.x <span class="op">*</span> <span class="fl">0.999</span>, centroide.y <span class="op">*</span> <span class="fl">0.999</span>)</span>
<span id="cb11-161"><a href="#cb11-161" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> geom_parcela.contains(punto_mod):</span>
<span id="cb11-162"><a href="#cb11-162" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> punto_mod</span>
<span id="cb11-163"><a href="#cb11-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb11-164"><a href="#cb11-164" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> centroide</span>
<span id="cb11-165"><a href="#cb11-165" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-166"><a href="#cb11-166" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'punto_propio'</span>] <span class="op">=</span> gdf_joined[<span class="st">'geom_parcela'</span>].<span class="bu">apply</span>(</span>
<span id="cb11-167"><a href="#cb11-167" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> g: crear_punto_dentro(g) <span class="cf">if</span> g <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb11-168"><a href="#cb11-168" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb11-169"><a href="#cb11-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-170"><a href="#cb11-170" aria-hidden="true" tabindex="-1"></a><span class="co"># 12. Extraer coords y SRID</span></span>
<span id="cb11-171"><a href="#cb11-171" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'coor_x'</span>] <span class="op">=</span> gdf_joined[<span class="st">'punto_propio'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.x <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb11-172"><a href="#cb11-172" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'coor_y'</span>] <span class="op">=</span> gdf_joined[<span class="st">'punto_propio'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.y <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb11-173"><a href="#cb11-173" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'srid'</span>] <span class="op">=</span> gdf_joined.crs.to_epsg()</span>
<span id="cb11-174"><a href="#cb11-174" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-175"><a href="#cb11-175" aria-hidden="true" tabindex="-1"></a><span class="co"># 13. Actualizar df_hs con los datos y score_callejero</span></span>
<span id="cb11-176"><a href="#cb11-176" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> gdf_joined.iterrows():</span>
<span id="cb11-177"><a href="#cb11-177" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.notna(row[<span class="st">'refcat'</span>]):</span>
<span id="cb11-178"><a href="#cb11-178" aria-hidden="true" tabindex="-1"></a>        ix <span class="op">=</span> row[<span class="st">'index'</span>]  <span class="co"># índice original en df_hs</span></span>
<span id="cb11-179"><a href="#cb11-179" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'civ'</span>] <span class="op">=</span> row[<span class="st">'refcat'</span>]</span>
<span id="cb11-180"><a href="#cb11-180" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'fuzzy - nvia callejero'</span></span>
<span id="cb11-181"><a href="#cb11-181" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_x'</span>] <span class="op">=</span> row[<span class="st">'coor_x'</span>]</span>
<span id="cb11-182"><a href="#cb11-182" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_y'</span>] <span class="op">=</span> row[<span class="st">'coor_y'</span>]</span>
<span id="cb11-183"><a href="#cb11-183" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'srid'</span>] <span class="op">=</span> row[<span class="st">'srid'</span>]</span>
<span id="cb11-184"><a href="#cb11-184" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'direccion_callejero'</span>] <span class="op">=</span> row[<span class="st">'direccion_callejero'</span>]</span>
<span id="cb11-185"><a href="#cb11-185" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'score_callejero'</span>] <span class="op">=</span> row[<span class="st">'score_callejero'</span>]</span>
<span id="cb11-186"><a href="#cb11-186" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-187"><a href="#cb11-187" aria-hidden="true" tabindex="-1"></a><span class="co"># 14. Guardar resultados</span></span>
<span id="cb11-188"><a href="#cb11-188" aria-hidden="true" tabindex="-1"></a><span class="co">#df_hs.to_excel('hs_contra_callejero_fuzzy_completo.xlsx', index=False)</span></span>
<span id="cb11-189"><a href="#cb11-189" aria-hidden="true" tabindex="-1"></a>df_hs[df_hs[<span class="st">'civ'</span>].notna()].to_excel(<span class="st">'hs_contra_callejero_fuzzy_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb11-190"><a href="#cb11-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-191"><a href="#cb11-191" aria-hidden="true" tabindex="-1"></a><span class="co"># 15. Resumen</span></span>
<span id="cb11-192"><a href="#cb11-192" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>()</span>
<span id="cb11-193"><a href="#cb11-193" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"=== HS CONTRA CALLEJERO (FUZZY MATCHING POR PORTAL) ==="</span>)</span>
<span id="cb11-194"><a href="#cb11-194" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total registros HS: </span><span class="sc">{</span><span class="bu">len</span>(df_hs)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-195"><a href="#cb11-195" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados M.E. contra VV: </span><span class="sc">{</span>df_hs[df_hs[<span class="st">'metodo-fuente'</span>]<span class="op">==</span><span class="st">'match exacto - vv'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-196"><a href="#cb11-196" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados fuzzy contra VV: </span><span class="sc">{</span>df_hs[df_hs[<span class="st">'metodo-fuente'</span>]<span class="op">==</span><span class="st">'fuzzy - vv'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-197"><a href="#cb11-197" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados M.E. contra finca: </span><span class="sc">{</span>df_hs[df_hs[<span class="st">'metodo-fuente'</span>]<span class="op">==</span><span class="st">'match exacto - finca'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-198"><a href="#cb11-198" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados M.E. contra callejero codvia: </span><span class="sc">{</span>df_hs[df_hs[<span class="st">'metodo-fuente'</span>]<span class="op">==</span><span class="st">'match exacto - codvia callejero'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-199"><a href="#cb11-199" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados fuzzy contra finca: </span><span class="sc">{</span>df_hs[df_hs[<span class="st">'metodo-fuente'</span>]<span class="op">==</span><span class="st">'fuzzy - finca'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-200"><a href="#cb11-200" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV asignados fuzzy contra callejero portal: </span><span class="sc">{</span>df_hs[df_hs[<span class="st">'metodo-fuente'</span>]<span class="op">==</span><span class="st">'fuzzy - nvia callejero'</span>]<span class="sc">.</span>shape[<span class="dv">0</span>]<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb11-201"><a href="#cb11-201" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total CIV completados: </span><span class="sc">{</span>df_hs[<span class="st">'civ'</span>]<span class="sc">.</span>notna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(df_hs[<span class="st">'civ'</span>].notna().<span class="bu">sum</span>()<span class="op">/</span><span class="bu">len</span>(df_hs))<span class="op">*</span><span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb11-202"><a href="#cb11-202" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total pendientes: </span><span class="sc">{</span>df_hs[<span class="st">'civ'</span>]<span class="sc">.</span>isna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---cc-match-exacto" class="level3" data-number="2.3.7">
<h3 data-number="2.3.7" class="anchored" data-anchor-id="hs---cc-match-exacto"><span class="header-section-number">2.3.7</span> HS - CC (match exacto)</h3>
<div id="dc0d72ed" class="cell" data-collapse="true" data-execution_count="15">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA CC (MATCH EXACTO POR DIRECCION) ===</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># Leer y cargar datos</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>df_hs_full <span class="op">=</span> df_hs.copy()</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>df_hs <span class="op">=</span> df_hs[df_hs[<span class="st">'civ'</span>].isna()].copy()</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegurar columnas necesarias</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>, <span class="st">'direccion_callejero'</span>, <span class="st">'metodo-fuente'</span>]:</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>        df_hs[col] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Normalizar direcciones</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>df_hs[<span class="st">'direccion_hs'</span>] <span class="op">=</span> df_hs.<span class="bu">apply</span>(</span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'cmun'</span>], row[<span class="st">'tvia'</span>], row[<span class="st">'nvia'</span>], row[<span class="st">'numer'</span>],</span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>        bloq<span class="op">=</span>row.get(<span class="st">'bloq'</span>), port<span class="op">=</span>row.get(<span class="st">'port'</span>)</span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Leer callejero con geometría y campos para dirección</span></span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>df_cc <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT ine_mun, tipo_vial, nombre_via, numero, extension, geom FROM age.cartociudad_portalpk_public"</span>,</span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span>)</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>df_cc[<span class="st">'direccion_cc'</span>] <span class="op">=</span> df_cc.<span class="bu">apply</span>(</span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>    <span class="kw">lambda</span> row: normalizar_direccion(</span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>        <span class="bu">str</span>(row[<span class="st">'ine_mun'</span>]).zfill(<span class="dv">5</span>)[<span class="op">-</span><span class="dv">2</span>:],  <span class="co"># últimos 2 dígitos del municipio</span></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'tipo_vial'</span>],            </span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'nombre_via'</span>],                  </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'numero'</span>],</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>        port<span class="op">=</span>row.get(<span class="st">'extension'</span>)  <span class="co"># &lt;-- NUEVO: usa 'extension' como si fuera 'port'</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a>    axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Leer parcelas catastrales con geometría</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT refcat, geom FROM catastro.parcela"</span>,</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb12-41"><a href="#cb12-41" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-42"><a href="#cb12-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-43"><a href="#cb12-43" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Hacer match exacto por dirección</span></span>
<span id="cb12-44"><a href="#cb12-44" aria-hidden="true" tabindex="-1"></a>df_hs[<span class="st">'index_hs'</span>] <span class="op">=</span> df_hs.index  <span class="co"># conservar índice original</span></span>
<span id="cb12-45"><a href="#cb12-45" aria-hidden="true" tabindex="-1"></a>df_join <span class="op">=</span> df_hs.merge(</span>
<span id="cb12-46"><a href="#cb12-46" aria-hidden="true" tabindex="-1"></a>    df_cc[[<span class="st">'direccion_cc'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb12-47"><a href="#cb12-47" aria-hidden="true" tabindex="-1"></a>    left_on<span class="op">=</span><span class="st">'direccion_hs'</span>,</span>
<span id="cb12-48"><a href="#cb12-48" aria-hidden="true" tabindex="-1"></a>    right_on<span class="op">=</span><span class="st">'direccion_cc'</span>,</span>
<span id="cb12-49"><a href="#cb12-49" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'inner'</span></span>
<span id="cb12-50"><a href="#cb12-50" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-51"><a href="#cb12-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-52"><a href="#cb12-52" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"[MATCH EXACTO - CartoCiudad] Coincidencias exactas por dirección: </span><span class="sc">{</span><span class="bu">len</span>(df_join)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-53"><a href="#cb12-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-54"><a href="#cb12-54" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Asignar direccion_callejero a df_hs usando merge seguro</span></span>
<span id="cb12-55"><a href="#cb12-55" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'direccion_cc'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb12-56"><a href="#cb12-56" aria-hidden="true" tabindex="-1"></a>    df_hs[<span class="st">'direccion_cc'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-57"><a href="#cb12-57" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-58"><a href="#cb12-58" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignar con base en índice original</span></span>
<span id="cb12-59"><a href="#cb12-59" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df_join.iterrows():</span>
<span id="cb12-60"><a href="#cb12-60" aria-hidden="true" tabindex="-1"></a>    ix <span class="op">=</span> row[<span class="st">'index_hs'</span>]</span>
<span id="cb12-61"><a href="#cb12-61" aria-hidden="true" tabindex="-1"></a>    df_hs.at[ix, <span class="st">'direccion_cc'</span>] <span class="op">=</span> row[<span class="st">'direccion_cc'</span>]</span>
<span id="cb12-62"><a href="#cb12-62" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-63"><a href="#cb12-63" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Crear GeoDataFrame con punto (centroide del portal)</span></span>
<span id="cb12-64"><a href="#cb12-64" aria-hidden="true" tabindex="-1"></a>df_join[<span class="st">'punto'</span>] <span class="op">=</span> df_join[<span class="st">'geom'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> g: g.centroid <span class="cf">if</span> g <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb12-65"><a href="#cb12-65" aria-hidden="true" tabindex="-1"></a>gdf_join <span class="op">=</span> gpd.GeoDataFrame(df_join, geometry<span class="op">=</span><span class="st">'punto'</span>, crs<span class="op">=</span>df_cc.crs)</span>
<span id="cb12-66"><a href="#cb12-66" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-67"><a href="#cb12-67" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Leer parcelas catastrales</span></span>
<span id="cb12-68"><a href="#cb12-68" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb12-69"><a href="#cb12-69" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT refcat, geom FROM catastro.parcela"</span>,</span>
<span id="cb12-70"><a href="#cb12-70" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb12-71"><a href="#cb12-71" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb12-72"><a href="#cb12-72" aria-hidden="true" tabindex="-1"></a>).to_crs(gdf_join.crs)</span>
<span id="cb12-73"><a href="#cb12-73" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-74"><a href="#cb12-74" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Join espacial: punto dentro de parcela</span></span>
<span id="cb12-75"><a href="#cb12-75" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gpd.sjoin(</span>
<span id="cb12-76"><a href="#cb12-76" aria-hidden="true" tabindex="-1"></a>    gdf_join,</span>
<span id="cb12-77"><a href="#cb12-77" aria-hidden="true" tabindex="-1"></a>    gdf_parcelas[[<span class="st">'refcat'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb12-78"><a href="#cb12-78" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb12-79"><a href="#cb12-79" aria-hidden="true" tabindex="-1"></a>    predicate<span class="op">=</span><span class="st">'within'</span></span>
<span id="cb12-80"><a href="#cb12-80" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-81"><a href="#cb12-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-82"><a href="#cb12-82" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gdf_joined.rename(columns<span class="op">=</span>{<span class="st">'geom'</span>: <span class="st">'geom_parcela'</span>})</span>
<span id="cb12-83"><a href="#cb12-83" aria-hidden="true" tabindex="-1"></a>gdf_joined <span class="op">=</span> gdf_joined.set_geometry(<span class="st">'geom_parcela'</span>)</span>
<span id="cb12-84"><a href="#cb12-84" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-85"><a href="#cb12-85" aria-hidden="true" tabindex="-1"></a><span class="co"># 8. Extraer coordenadas y srid</span></span>
<span id="cb12-86"><a href="#cb12-86" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'coor_x'</span>] <span class="op">=</span> gdf_joined[<span class="st">'punto'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.x <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb12-87"><a href="#cb12-87" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'coor_y'</span>] <span class="op">=</span> gdf_joined[<span class="st">'punto'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.y <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb12-88"><a href="#cb12-88" aria-hidden="true" tabindex="-1"></a>gdf_joined[<span class="st">'srid'</span>] <span class="op">=</span> gdf_joined.crs.to_epsg()</span>
<span id="cb12-89"><a href="#cb12-89" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-90"><a href="#cb12-90" aria-hidden="true" tabindex="-1"></a><span class="co"># 9. Actualizar df_hs con los resultados</span></span>
<span id="cb12-91"><a href="#cb12-91" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> gdf_joined.iterrows():</span>
<span id="cb12-92"><a href="#cb12-92" aria-hidden="true" tabindex="-1"></a>    ix <span class="op">=</span> row[<span class="st">'index_hs'</span>]</span>
<span id="cb12-93"><a href="#cb12-93" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.notna(row[<span class="st">'refcat'</span>]):</span>
<span id="cb12-94"><a href="#cb12-94" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'civ'</span>] <span class="op">=</span> row[<span class="st">'refcat'</span>]</span>
<span id="cb12-95"><a href="#cb12-95" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'match exacto - cc'</span></span>
<span id="cb12-96"><a href="#cb12-96" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_x'</span>] <span class="op">=</span> row[<span class="st">'coor_x'</span>]</span>
<span id="cb12-97"><a href="#cb12-97" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_y'</span>] <span class="op">=</span> row[<span class="st">'coor_y'</span>]</span>
<span id="cb12-98"><a href="#cb12-98" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'srid'</span>] <span class="op">=</span> row[<span class="st">'srid'</span>]</span>
<span id="cb12-99"><a href="#cb12-99" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'direccion_cc'</span>] <span class="op">=</span> row[<span class="st">'direccion_cc'</span>]</span>
<span id="cb12-100"><a href="#cb12-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-101"><a href="#cb12-101" aria-hidden="true" tabindex="-1"></a><span class="co"># Asegurar que todas las columnas de df_hs existen en df_hs_full</span></span>
<span id="cb12-102"><a href="#cb12-102" aria-hidden="true" tabindex="-1"></a>columnas_nuevas <span class="op">=</span> [<span class="st">'direccion_cc'</span>, <span class="st">'metodo-fuente'</span>, <span class="st">'coor_x'</span>, <span class="st">'coor_y'</span>, <span class="st">'srid'</span>]</span>
<span id="cb12-103"><a href="#cb12-103" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> columnas_nuevas:</span>
<span id="cb12-104"><a href="#cb12-104" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb12-105"><a href="#cb12-105" aria-hidden="true" tabindex="-1"></a>        df_hs[col] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-106"><a href="#cb12-106" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_hs_full.columns:</span>
<span id="cb12-107"><a href="#cb12-107" aria-hidden="true" tabindex="-1"></a>        df_hs_full[col] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb12-108"><a href="#cb12-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-109"><a href="#cb12-109" aria-hidden="true" tabindex="-1"></a><span class="co"># 10. Guardar resultados</span></span>
<span id="cb12-110"><a href="#cb12-110" aria-hidden="true" tabindex="-1"></a>df_hs_full.loc[df_hs.index, :] <span class="op">=</span> df_hs</span>
<span id="cb12-111"><a href="#cb12-111" aria-hidden="true" tabindex="-1"></a>df_hs_full[df_hs_full[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - cc'</span>].to_excel(<span class="st">'hs_contra_cc_exacto_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-112"><a href="#cb12-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-113"><a href="#cb12-113" aria-hidden="true" tabindex="-1"></a><span class="co"># 11. Resumen</span></span>
<span id="cb12-114"><a href="#cb12-114" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== HS CONTRA CARTOCIUDAD - MATCH EXACTO ==="</span>)</span>
<span id="cb12-115"><a href="#cb12-115" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total HS sin CIV antes: </span><span class="sc">{</span><span class="bu">len</span>(df_hs)<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-116"><a href="#cb12-116" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV recuperados por match exacto: </span><span class="sc">{</span>(df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'match exacto - cc'</span>)<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb12-117"><a href="#cb12-117" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Pendientes tras match exacto: </span><span class="sc">{</span>df_hs[<span class="st">'civ'</span>]<span class="sc">.</span>isna()<span class="sc">.</span><span class="bu">sum</span>()<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>(df_hs[<span class="st">'civ'</span>].isna().mean() <span class="op">*</span> <span class="dv">100</span>)<span class="sc">:.2f}</span><span class="ss">%)"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
<section id="hs---cc-fuzzy-match" class="level3" data-number="2.3.8">
<h3 data-number="2.3.8" class="anchored" data-anchor-id="hs---cc-fuzzy-match"><span class="header-section-number">2.3.8</span> HS - CC (fuzzy match)</h3>
<div id="78b97161" class="cell" data-collapse="true" data-execution_count="16">
<details class="code-fold">
<summary>Code</summary>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># === HS CONTRA CC (FUZZY MATCH POR DIRECCION) ===</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>df_hs <span class="op">=</span> df_hs_full[df_hs_full[<span class="st">'civ'</span>].isna()].copy()</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'metodo-fuente'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs_full.columns:</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    df_hs_full[<span class="st">'metodo-fuente'</span>] <span class="op">=</span> pd.NA </span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>score_cutoff <span class="op">=</span> <span class="dv">80</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>cosine_threshold <span class="op">=</span> <span class="fl">0.63</span>  <span class="co"># puedes afinar este valor</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>vectorizer <span class="op">=</span> TfidfVectorizer().fit(df_cc[<span class="st">'direccion_cc'</span>].astype(<span class="bu">str</span>).tolist())</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="co"># 0. Normalización</span></span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extraer_municipio(direccion):</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(direccion, <span class="bu">str</span>) <span class="kw">and</span> direccion.split()[<span class="dv">0</span>].isdigit():</span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="bu">int</span>(direccion.split()[<span class="dv">0</span>])</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="op">-</span><span class="dv">1</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> extraer_numero_portal(direccion):</span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="bu">isinstance</span>(direccion, <span class="bu">str</span>):</span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>        match <span class="op">=</span> re.findall(<span class="vs">r'</span><span class="dv">\d</span><span class="op">+</span><span class="pp">[A-Z]</span><span class="op">*</span><span class="dv">$</span><span class="vs">'</span>, direccion)</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> match:</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>            <span class="cf">return</span> normalizar_numero_portal(match[<span class="dv">0</span>])  <span class="co"># usa la versión robusta</span></span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> <span class="st">''</span></span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a><span class="co"># 1. Aplicar al df_cc</span></span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>df_cc[<span class="st">'municipio'</span>] <span class="op">=</span> df_cc[<span class="st">'direccion_cc'</span>].<span class="bu">apply</span>(extraer_municipio)</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>df_cc[<span class="st">'numero_portal'</span>] <span class="op">=</span> df_cc[<span class="st">'direccion_cc'</span>].<span class="bu">apply</span>(extraer_numero_portal)</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a><span class="co"># 2. Crear índice {(municipio, numero_portal): [índices]}</span></span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>cc_index <span class="op">=</span> {}</span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, row <span class="kw">in</span> df_cc.iterrows():</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> (row[<span class="st">'municipio'</span>], row[<span class="st">'numero_portal'</span>])</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    cc_index.setdefault(key, []).append(idx)</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'score_cc'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    df_hs[<span class="st">'score_cc'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a><span class="co"># 3. Función fuzzy</span></span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> fuzzy_match_direccion(row):</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.notna(row[<span class="st">'civ'</span>]):</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>        cmun <span class="op">=</span> <span class="bu">int</span>(row[<span class="st">'cmun'</span>])</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">try</span>:</span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>        numer_norm <span class="op">=</span> normalizar_numero_portal(row[<span class="st">'numer'</span>])</span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="cf">except</span>:</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row</span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    key <span class="op">=</span> (cmun, numer_norm)</span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    candidates_idx <span class="op">=</span> cc_index.get(key, [])</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> candidates_idx:</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    candidates <span class="op">=</span> df_cc.loc[candidates_idx, <span class="st">'direccion_cc'</span>].astype(<span class="bu">str</span>).tolist()</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    match_data <span class="op">=</span> process.extractOne(</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'direccion_hs'</span>], candidates,</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>        scorer<span class="op">=</span>rapidfuzz_fuzz.ratio,</span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>        score_cutoff<span class="op">=</span>score_cutoff</span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="kw">not</span> match_data:</span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> row</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    match, score, match_idx <span class="op">=</span> match_data</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    matched_text <span class="op">=</span> match</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># ---- Segundo filtro: similitud coseno con TF-IDF ----</span></span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    tfidf_query <span class="op">=</span> vectorizer.transform([row[<span class="st">'direccion_hs'</span>]])</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    tfidf_match <span class="op">=</span> vectorizer.transform([matched_text])</span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>    sim_coseno <span class="op">=</span> cosine_similarity(tfidf_query, tfidf_match)[<span class="dv">0</span>, <span class="dv">0</span>]</span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> score <span class="op">&gt;=</span> score_cutoff <span class="kw">and</span> sim_coseno <span class="op">&gt;=</span> cosine_threshold:</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>        cc_row <span class="op">=</span> df_cc.loc[candidates_idx[match_idx]]</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'metodo-fuente'</span>] <span class="op">=</span> <span class="st">'fuzzy - cc'</span></span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'direccion_cc'</span>] <span class="op">=</span> cc_row.get(<span class="st">'direccion_cc'</span>, <span class="va">None</span>)</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'score_cc'</span>] <span class="op">=</span> score</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'similitud_cc'</span>] <span class="op">=</span> sim_coseno  <span class="co"># &lt;-- opcional, para análisis posterior</span></span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> cc_row.get(<span class="st">'geom'</span>) <span class="kw">is</span> <span class="kw">not</span> <span class="va">None</span>:</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>            punto <span class="op">=</span> cc_row[<span class="st">'geom'</span>].centroid</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'coor_x'</span>] <span class="op">=</span> punto.x</span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'coor_y'</span>] <span class="op">=</span> punto.y</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'srid'</span>] <span class="op">=</span> df_cc.crs.to_epsg() <span class="cf">if</span> df_cc.crs <span class="cf">else</span> <span class="va">None</span></span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>        <span class="cf">else</span>:</span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'coor_x'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'coor_y'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>            row[<span class="st">'srid'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>    <span class="cf">else</span>:</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'score_cc'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>        row[<span class="st">'similitud_cc'</span>] <span class="op">=</span> sim_coseno</span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> row</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>df_hs[<span class="st">'similitud_cc'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> rapidfuzz <span class="im">import</span> fuzz <span class="im">as</span> rapidfuzz_fuzz</span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'direccion_cc'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs.columns:</span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>    df_hs[<span class="st">'direccion_cc'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="st">'direccion_cc'</span> <span class="kw">not</span> <span class="kw">in</span> df_hs_full.columns:</span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>    df_hs_full[<span class="st">'direccion_cc'</span>] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a><span class="co"># 4. Aplicar fuzzy</span></span>
<span id="cb13-109"><a href="#cb13-109" aria-hidden="true" tabindex="-1"></a>df_hs[<span class="st">'index_hs'</span>] <span class="op">=</span> df_hs.index  </span>
<span id="cb13-110"><a href="#cb13-110" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-111"><a href="#cb13-111" aria-hidden="true" tabindex="-1"></a>sin_civ_antes <span class="op">=</span> df_hs[<span class="st">'civ'</span>].isna().<span class="bu">sum</span>()</span>
<span id="cb13-112"><a href="#cb13-112" aria-hidden="true" tabindex="-1"></a>mask_sin_civ <span class="op">=</span> df_hs[<span class="st">'civ'</span>].isna()</span>
<span id="cb13-113"><a href="#cb13-113" aria-hidden="true" tabindex="-1"></a>df_tmp <span class="op">=</span> df_hs.loc[mask_sin_civ].<span class="bu">apply</span>(fuzzy_match_direccion, axis<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb13-114"><a href="#cb13-114" aria-hidden="true" tabindex="-1"></a>df_hs.loc[mask_sin_civ, df_tmp.columns] <span class="op">=</span> df_tmp</span>
<span id="cb13-115"><a href="#cb13-115" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-116"><a href="#cb13-116" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-117"><a href="#cb13-117" aria-hidden="true" tabindex="-1"></a><span class="co"># 5. Join espacial para obtener refcat (CIV) en fuzzy</span></span>
<span id="cb13-118"><a href="#cb13-118" aria-hidden="true" tabindex="-1"></a><span class="co"># Filtrar matches</span></span>
<span id="cb13-119"><a href="#cb13-119" aria-hidden="true" tabindex="-1"></a>fuzzy_matches <span class="op">=</span> df_hs[df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'fuzzy - cc'</span>].copy()</span>
<span id="cb13-120"><a href="#cb13-120" aria-hidden="true" tabindex="-1"></a>fuzzy_matches <span class="op">=</span> fuzzy_matches.merge(</span>
<span id="cb13-121"><a href="#cb13-121" aria-hidden="true" tabindex="-1"></a>    df_cc[[<span class="st">'direccion_cc'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb13-122"><a href="#cb13-122" aria-hidden="true" tabindex="-1"></a>    on<span class="op">=</span><span class="st">'direccion_cc'</span>,</span>
<span id="cb13-123"><a href="#cb13-123" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span></span>
<span id="cb13-124"><a href="#cb13-124" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-125"><a href="#cb13-125" aria-hidden="true" tabindex="-1"></a>fuzzy_matches[<span class="st">'punto'</span>] <span class="op">=</span> fuzzy_matches[<span class="st">'geom'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> g: g.centroid <span class="cf">if</span> g <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb13-126"><a href="#cb13-126" aria-hidden="true" tabindex="-1"></a>gdf_fuzzy <span class="op">=</span> gpd.GeoDataFrame(fuzzy_matches, geometry<span class="op">=</span><span class="st">'punto'</span>, crs<span class="op">=</span>df_cc.crs)</span>
<span id="cb13-127"><a href="#cb13-127" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-128"><a href="#cb13-128" aria-hidden="true" tabindex="-1"></a><span class="co"># Cargar parcelas</span></span>
<span id="cb13-129"><a href="#cb13-129" aria-hidden="true" tabindex="-1"></a>gdf_parcelas <span class="op">=</span> gpd.read_postgis(</span>
<span id="cb13-130"><a href="#cb13-130" aria-hidden="true" tabindex="-1"></a>    <span class="st">"SELECT refcat, geom FROM catastro.parcela"</span>,</span>
<span id="cb13-131"><a href="#cb13-131" aria-hidden="true" tabindex="-1"></a>    con<span class="op">=</span>engine,</span>
<span id="cb13-132"><a href="#cb13-132" aria-hidden="true" tabindex="-1"></a>    geom_col<span class="op">=</span><span class="st">'geom'</span></span>
<span id="cb13-133"><a href="#cb13-133" aria-hidden="true" tabindex="-1"></a>).to_crs(gdf_fuzzy.crs)</span>
<span id="cb13-134"><a href="#cb13-134" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-135"><a href="#cb13-135" aria-hidden="true" tabindex="-1"></a><span class="co"># Join espacial</span></span>
<span id="cb13-136"><a href="#cb13-136" aria-hidden="true" tabindex="-1"></a>gdf_fuzzy_joined <span class="op">=</span> gpd.sjoin(</span>
<span id="cb13-137"><a href="#cb13-137" aria-hidden="true" tabindex="-1"></a>    gdf_fuzzy,</span>
<span id="cb13-138"><a href="#cb13-138" aria-hidden="true" tabindex="-1"></a>    gdf_parcelas[[<span class="st">'refcat'</span>, <span class="st">'geom'</span>]],</span>
<span id="cb13-139"><a href="#cb13-139" aria-hidden="true" tabindex="-1"></a>    how<span class="op">=</span><span class="st">'left'</span>,</span>
<span id="cb13-140"><a href="#cb13-140" aria-hidden="true" tabindex="-1"></a>    predicate<span class="op">=</span><span class="st">'within'</span></span>
<span id="cb13-141"><a href="#cb13-141" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-142"><a href="#cb13-142" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-143"><a href="#cb13-143" aria-hidden="true" tabindex="-1"></a><span class="co"># Extraer coordenadas</span></span>
<span id="cb13-144"><a href="#cb13-144" aria-hidden="true" tabindex="-1"></a>gdf_fuzzy_joined[<span class="st">'coor_x'</span>] <span class="op">=</span> gdf_fuzzy_joined[<span class="st">'punto'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.x <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb13-145"><a href="#cb13-145" aria-hidden="true" tabindex="-1"></a>gdf_fuzzy_joined[<span class="st">'coor_y'</span>] <span class="op">=</span> gdf_fuzzy_joined[<span class="st">'punto'</span>].<span class="bu">apply</span>(<span class="kw">lambda</span> p: p.y <span class="cf">if</span> p <span class="cf">else</span> <span class="va">None</span>)</span>
<span id="cb13-146"><a href="#cb13-146" aria-hidden="true" tabindex="-1"></a>gdf_fuzzy_joined[<span class="st">'srid'</span>] <span class="op">=</span> gdf_fuzzy_joined.crs.to_epsg()</span>
<span id="cb13-147"><a href="#cb13-147" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-148"><a href="#cb13-148" aria-hidden="true" tabindex="-1"></a><span class="co"># Asignar refcat a df_hs</span></span>
<span id="cb13-149"><a href="#cb13-149" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> _, row <span class="kw">in</span> gdf_fuzzy_joined.iterrows():</span>
<span id="cb13-150"><a href="#cb13-150" aria-hidden="true" tabindex="-1"></a>    ix <span class="op">=</span> row[<span class="st">'index_hs'</span>]</span>
<span id="cb13-151"><a href="#cb13-151" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> pd.notna(row[<span class="st">'refcat'</span>]):</span>
<span id="cb13-152"><a href="#cb13-152" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'civ'</span>] <span class="op">=</span> row[<span class="st">'refcat'</span>]</span>
<span id="cb13-153"><a href="#cb13-153" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_x'</span>] <span class="op">=</span> row[<span class="st">'coor_x'</span>]</span>
<span id="cb13-154"><a href="#cb13-154" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'coor_y'</span>] <span class="op">=</span> row[<span class="st">'coor_y'</span>]</span>
<span id="cb13-155"><a href="#cb13-155" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'srid'</span>] <span class="op">=</span> row[<span class="st">'srid'</span>]</span>
<span id="cb13-156"><a href="#cb13-156" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'direccion_cc'</span>] <span class="op">=</span> row[<span class="st">'direccion_cc'</span>]</span>
<span id="cb13-157"><a href="#cb13-157" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'score_cc'</span>] <span class="op">=</span> row[<span class="st">'score_cc'</span>]</span>
<span id="cb13-158"><a href="#cb13-158" aria-hidden="true" tabindex="-1"></a>        df_hs.at[ix, <span class="st">'similitud_cc'</span>] <span class="op">=</span> row[<span class="st">'similitud_cc'</span>]</span>
<span id="cb13-159"><a href="#cb13-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-160"><a href="#cb13-160" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-161"><a href="#cb13-161" aria-hidden="true" tabindex="-1"></a><span class="co"># 6. Informe</span></span>
<span id="cb13-162"><a href="#cb13-162" aria-hidden="true" tabindex="-1"></a>sin_civ_despues <span class="op">=</span> df_hs[<span class="st">'civ'</span>].isna().<span class="bu">sum</span>()</span>
<span id="cb13-163"><a href="#cb13-163" aria-hidden="true" tabindex="-1"></a>fuzzy_recuperados <span class="op">=</span> (df_hs[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'fuzzy - cc'</span>).<span class="bu">sum</span>()</span>
<span id="cb13-164"><a href="#cb13-164" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-165"><a href="#cb13-165" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"</span><span class="ch">\n</span><span class="st">=== HS CONTRA CARTOCIUDAD - FUZZY MATCHING ==="</span>)</span>
<span id="cb13-166"><a href="#cb13-166" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Total HS sin CIV antes: </span><span class="sc">{</span>sin_civ_antes<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-167"><a href="#cb13-167" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"CIV recuperados por fuzzy match: </span><span class="sc">{</span>fuzzy_recuperados<span class="sc">}</span><span class="ss">"</span>)</span>
<span id="cb13-168"><a href="#cb13-168" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="ss">f"Pendientes tras fuzzy match: </span><span class="sc">{</span>sin_civ_despues<span class="sc">}</span><span class="ss"> (</span><span class="sc">{</span>sin_civ_despues <span class="op">/</span> <span class="bu">len</span>(df_hs) <span class="op">*</span> <span class="dv">100</span><span class="sc">:.2f}</span><span class="ss">%)"</span>)</span>
<span id="cb13-169"><a href="#cb13-169" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-170"><a href="#cb13-170" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> col <span class="kw">in</span> [<span class="st">'direccion_cc'</span>, <span class="st">'score_cc'</span>, <span class="st">'similitud_cc'</span>]:</span>
<span id="cb13-171"><a href="#cb13-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> col <span class="kw">not</span> <span class="kw">in</span> df_hs_full.columns:</span>
<span id="cb13-172"><a href="#cb13-172" aria-hidden="true" tabindex="-1"></a>        df_hs_full[col] <span class="op">=</span> <span class="va">None</span></span>
<span id="cb13-173"><a href="#cb13-173" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-174"><a href="#cb13-174" aria-hidden="true" tabindex="-1"></a>df_hs_full.loc[df_hs.index, :] <span class="op">=</span> df_hs</span>
<span id="cb13-175"><a href="#cb13-175" aria-hidden="true" tabindex="-1"></a>df_hs <span class="op">=</span> df_hs_full</span>
<span id="cb13-176"><a href="#cb13-176" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-177"><a href="#cb13-177" aria-hidden="true" tabindex="-1"></a><span class="co"># 7. Guardar resultados</span></span>
<span id="cb13-178"><a href="#cb13-178" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar solo los asignados por fuzzy contra CartoCiudad</span></span>
<span id="cb13-179"><a href="#cb13-179" aria-hidden="true" tabindex="-1"></a>df_hs_full[df_hs_full[<span class="st">'metodo-fuente'</span>] <span class="op">==</span> <span class="st">'fuzzy - cc'</span>].to_excel(<span class="st">'hs_contra_cc_fuzzy_con_civ.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-180"><a href="#cb13-180" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Archivo Excel con matches por fuzzy guardado en: hs_contra_cc_fuzzy_civ.xlsx"</span>)</span>
<span id="cb13-181"><a href="#cb13-181" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-182"><a href="#cb13-182" aria-hidden="true" tabindex="-1"></a><span class="co"># Guardar el dataset final completo (con todos los métodos)</span></span>
<span id="cb13-183"><a href="#cb13-183" aria-hidden="true" tabindex="-1"></a>df_hs.to_excel(<span class="st">'hs_final_completo.xlsx'</span>, index<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb13-184"><a href="#cb13-184" aria-hidden="true" tabindex="-1"></a><span class="bu">print</span>(<span class="st">"Archivo Excel final completo guardado en: hs_final_completo.xlsx"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</details>
</div>
</section>
</section>
</section>
<section id="resultados" class="level1" data-number="3">
<h1 data-number="3"><span class="header-section-number">3</span> Resultados</h1>
<p>En esta primera aproximación se ha conseguido la asignación del <strong>82,25 %</strong> del total de registros del fichero HS, distribuida de la siguiente manera según su método y fuente de recuperación:</p>
<div id="0f52603e" class="cell" data-execution_count="17">
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><img src="a1_informe_files/figure-html/cell-18-output-1.png" width="948" height="374" class="figure-img"></p>
</figure>
</div>
</div>
</div>
<section id="distribución-por-municipio" class="level2" data-number="3.1">
<h2 data-number="3.1" class="anchored" data-anchor-id="distribución-por-municipio"><span class="header-section-number">3.1</span> Distribución por municipio</h2>
<div id="28bdd4f9" class="cell" data-execution_count="18">
<div class="cell-output cell-output-display">

<figure class="table-responsive figure">
    
    <table class="dataframe table table-striped table-hover table-bordered table-sm small">
  <thead>
    <tr>
      <th>Municipio</th>
      <th>HH</th>
      <th>HS</th>
      <th>Asignados</th>
      <th>M.E. - VV</th>
      <th>Fuzzy - VV</th>
      <th>M.E. - Finca</th>
      <th>Fuzzy - Finca</th>
      <th>M.E. - Codvia CLG</th>
      <th>Fuzzy - Nvia CLG</th>
      <th>M.E. - CC</th>
      <th>Fuzzy - CC</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>Arafo</td>
      <td>2041</td>
      <td>1322</td>
      <td>1090 (82.45%)</td>
      <td>66 (6.06%)</td>
      <td>138 (12.66%)</td>
      <td>15 (1.38%)</td>
      <td>15 (1.38%)</td>
      <td>847 (77.71%)</td>
      <td>6 (0.55%)</td>
      <td>0 (0.0%)</td>
      <td>3 (0.28%)</td>
    </tr>
    <tr>
      <td>Arico</td>
      <td>3532</td>
      <td>2173</td>
      <td>1667 (76.71%)</td>
      <td>218 (13.08%)</td>
      <td>430 (25.79%)</td>
      <td>88 (5.28%)</td>
      <td>74 (4.44%)</td>
      <td>769 (46.13%)</td>
      <td>77 (4.62%)</td>
      <td>2 (0.12%)</td>
      <td>9 (0.54%)</td>
    </tr>
    <tr>
      <td>Buenavista del Norte</td>
      <td>1758</td>
      <td>1094</td>
      <td>855 (78.15%)</td>
      <td>34 (3.98%)</td>
      <td>57 (6.67%)</td>
      <td>20 (2.34%)</td>
      <td>21 (2.46%)</td>
      <td>682 (79.77%)</td>
      <td>37 (4.33%)</td>
      <td>2 (0.23%)</td>
      <td>2 (0.23%)</td>
    </tr>
    <tr>
      <td>Fasnia</td>
      <td>1193</td>
      <td>1000</td>
      <td>644 (64.40%)</td>
      <td>28 (4.35%)</td>
      <td>33 (5.12%)</td>
      <td>14 (2.17%)</td>
      <td>12 (1.86%)</td>
      <td>536 (83.23%)</td>
      <td>17 (2.64%)</td>
      <td>0 (0.0%)</td>
      <td>4 (0.62%)</td>
    </tr>
    <tr>
      <td>Garachico</td>
      <td>1747</td>
      <td>806</td>
      <td>713 (88.46%)</td>
      <td>130 (18.23%)</td>
      <td>91 (12.76%)</td>
      <td>110 (15.43%)</td>
      <td>70 (9.82%)</td>
      <td>298 (41.8%)</td>
      <td>3 (0.42%)</td>
      <td>0 (0.0%)</td>
      <td>11 (1.54%)</td>
    </tr>
    <tr>
      <td>La Guancha</td>
      <td>1940</td>
      <td>1022</td>
      <td>887 (86.79%)</td>
      <td>88 (9.92%)</td>
      <td>213 (24.01%)</td>
      <td>19 (2.14%)</td>
      <td>16 (1.8%)</td>
      <td>543 (61.22%)</td>
      <td>6 (0.68%)</td>
      <td>0 (0.0%)</td>
      <td>2 (0.23%)</td>
    </tr>
    <tr>
      <td>La Matanza de Acentejo</td>
      <td>3168</td>
      <td>1601</td>
      <td>1227 (76.64%)</td>
      <td>174 (14.18%)</td>
      <td>93 (7.58%)</td>
      <td>42 (3.42%)</td>
      <td>26 (2.12%)</td>
      <td>767 (62.51%)</td>
      <td>115 (9.37%)</td>
      <td>2 (0.16%)</td>
      <td>8 (0.65%)</td>
    </tr>
    <tr>
      <td>El Rosario</td>
      <td>6329</td>
      <td>5197</td>
      <td>4270 (82.16%)</td>
      <td>1054 (24.68%)</td>
      <td>223 (5.22%)</td>
      <td>51 (1.19%)</td>
      <td>54 (1.26%)</td>
      <td>2809 (65.78%)</td>
      <td>70 (1.64%)</td>
      <td>3 (0.07%)</td>
      <td>6 (0.14%)</td>
    </tr>
    <tr>
      <td>San Juan de la Rambla</td>
      <td>1625</td>
      <td>1025</td>
      <td>765 (74.63%)</td>
      <td>34 (4.44%)</td>
      <td>94 (12.29%)</td>
      <td>37 (4.84%)</td>
      <td>11 (1.44%)</td>
      <td>538 (70.33%)</td>
      <td>48 (6.27%)</td>
      <td>0 (0.0%)</td>
      <td>3 (0.39%)</td>
    </tr>
    <tr>
      <td>Santa Úrsula</td>
      <td>5690</td>
      <td>2632</td>
      <td>2258 (85.79%)</td>
      <td>319 (14.13%)</td>
      <td>271 (12.0%)</td>
      <td>47 (2.08%)</td>
      <td>16 (0.71%)</td>
      <td>1499 (66.39%)</td>
      <td>58 (2.57%)</td>
      <td>4 (0.18%)</td>
      <td>44 (1.95%)</td>
    </tr>
    <tr>
      <td>Santiago del Teide</td>
      <td>4232</td>
      <td>1915</td>
      <td>1555 (81.20%)</td>
      <td>231 (14.86%)</td>
      <td>343 (22.06%)</td>
      <td>19 (1.22%)</td>
      <td>8 (0.51%)</td>
      <td>784 (50.42%)</td>
      <td>28 (1.8%)</td>
      <td>9 (0.58%)</td>
      <td>133 (8.55%)</td>
    </tr>
    <tr>
      <td>El Sauzal</td>
      <td>3188</td>
      <td>2008</td>
      <td>1751 (87.20%)</td>
      <td>141 (8.05%)</td>
      <td>116 (6.62%)</td>
      <td>25 (1.43%)</td>
      <td>4 (0.23%)</td>
      <td>1433 (81.84%)</td>
      <td>12 (0.69%)</td>
      <td>4 (0.23%)</td>
      <td>16 (0.91%)</td>
    </tr>
    <tr>
      <td>Los Silos</td>
      <td>1677</td>
      <td>1031</td>
      <td>848 (82.25%)</td>
      <td>108 (12.74%)</td>
      <td>117 (13.8%)</td>
      <td>29 (3.42%)</td>
      <td>23 (2.71%)</td>
      <td>537 (63.33%)</td>
      <td>27 (3.18%)</td>
      <td>0 (0.0%)</td>
      <td>7 (0.83%)</td>
    </tr>
    <tr>
      <td>El Tanque</td>
      <td>1010</td>
      <td>566</td>
      <td>416 (73.50%)</td>
      <td>202 (48.56%)</td>
      <td>46 (11.06%)</td>
      <td>27 (6.49%)</td>
      <td>8 (1.92%)</td>
      <td>129 (31.01%)</td>
      <td>4 (0.96%)</td>
      <td>0 (0.0%)</td>
      <td>0 (0.0%)</td>
    </tr>
    <tr>
      <td>Tegueste</td>
      <td>3939</td>
      <td>1664</td>
      <td>1573 (94.53%)</td>
      <td>205 (13.03%)</td>
      <td>75 (4.77%)</td>
      <td>30 (1.91%)</td>
      <td>5 (0.32%)</td>
      <td>1200 (76.29%)</td>
      <td>50 (3.18%)</td>
      <td>0 (0.0%)</td>
      <td>8 (0.51%)</td>
    </tr>
    <tr>
      <td>La Victoria de Acentejo</td>
      <td>3452</td>
      <td>1710</td>
      <td>1527 (89.30%)</td>
      <td>172 (11.26%)</td>
      <td>461 (30.19%)</td>
      <td>20 (1.31%)</td>
      <td>53 (3.47%)</td>
      <td>683 (44.73%)</td>
      <td>27 (1.77%)</td>
      <td>33 (2.16%)</td>
      <td>78 (5.11%)</td>
    </tr>
    <tr>
      <td>Vilaflor de Chasna</td>
      <td>704</td>
      <td>418</td>
      <td>312 (74.64%)</td>
      <td>76 (24.36%)</td>
      <td>48 (15.38%)</td>
      <td>16 (5.13%)</td>
      <td>4 (1.28%)</td>
      <td>161 (51.6%)</td>
      <td>1 (0.32%)</td>
      <td>5 (1.6%)</td>
      <td>1 (0.32%)</td>
    </tr>
    <tr>
      <td>TOTAL</td>
      <td>47225</td>
      <td>27184</td>
      <td>22358 (82.25%)</td>
      <td>3280 (14.67%)</td>
      <td>2849 (12.74%)</td>
      <td>609 (2.72%)</td>
      <td>420 (1.88%)</td>
      <td>14215 (63.58%)</td>
      <td>586 (2.62%)</td>
      <td>64 (0.29%)</td>
      <td>335 (1.5%)</td>
    </tr>
  </tbody>
</table>
    <figcaption style="font-size:0.85rem; margin-top:5px;">
        Tabla 1. Número y porcentaje de hogares sin CIV (HS) asignados según la aproximación empleada [M.E. (match exacto) o Fuzzy (coincidencia difusa)], así como la fuente contra la que se ha conseguido asignación [VV (Fichero de Viviendas), Finca (Catastro), CLG (Callejero GRAFCAN por código o nombre de vía) o CC (Cartociudad)], 
    </figcaption>
</figure>
</div>
</div>
</section>
<section id="productos-cartográficos" class="level2" data-number="3.2">
<h2 data-number="3.2" class="anchored" data-anchor-id="productos-cartográficos"><span class="header-section-number">3.2</span> Productos cartográficos</h2>
<p>A continuación, se muestra la distribución espacial de los hogares asignados a través de una serie de mapas con estadísticos relevantes. Si se desea una visualización más interactiva que permita explorar zonas con más detalle se puede consultar el siguiente <a href="https://erensan-1.github.io/a1_padron_online/a1_hs_recuperados.html#11/28.2966/-16.4777" target="_blank">visor</a>, que permite el filtrado por municipio y por fuente - método de asignación.</p>
<div class="tabset-margin-container"></div><div class="panel-tabset">
<ul class="nav nav-tabs" role="tablist"><li class="nav-item" role="presentation"><a class="nav-link active" id="tabset-1-1-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-1" role="tab" aria-controls="tabset-1-1" aria-selected="true" href="">Arafo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-2-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-2" role="tab" aria-controls="tabset-1-2" aria-selected="false" href="">Arico</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-3-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-3" role="tab" aria-controls="tabset-1-3" aria-selected="false" href="">Buenavista del Norte</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-4-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-4" role="tab" aria-controls="tabset-1-4" aria-selected="false" href="">El Rosario</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-5-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-5" role="tab" aria-controls="tabset-1-5" aria-selected="false" href="">El Sauzal</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-6-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-6" role="tab" aria-controls="tabset-1-6" aria-selected="false" href="">El Tanque</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-7-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-7" role="tab" aria-controls="tabset-1-7" aria-selected="false" href="">Fasnia</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-8-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-8" role="tab" aria-controls="tabset-1-8" aria-selected="false" href="">Garachico</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-9-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-9" role="tab" aria-controls="tabset-1-9" aria-selected="false" href="">La Guancha</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-10-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-10" role="tab" aria-controls="tabset-1-10" aria-selected="false" href="">La Matanza de Acentejo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-11-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-11" role="tab" aria-controls="tabset-1-11" aria-selected="false" href="">La Victoria de Acentejo</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-12-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-12" role="tab" aria-controls="tabset-1-12" aria-selected="false" href="">Los Silos</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-13-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-13" role="tab" aria-controls="tabset-1-13" aria-selected="false" href="">San Juan de la Rambla</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-14-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-14" role="tab" aria-controls="tabset-1-14" aria-selected="false" href="">Santiago del Teide</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-15-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-15" role="tab" aria-controls="tabset-1-15" aria-selected="false" href="">Tegueste</a></li><li class="nav-item" role="presentation"><a class="nav-link" id="tabset-1-16-tab" data-bs-toggle="tab" data-bs-target="#tabset-1-16" role="tab" aria-controls="tabset-1-16" aria-selected="false" href="">Vilaflor</a></li></ul>
<div class="tab-content">
<div id="tabset-1-1" class="tab-pane active" role="tabpanel" aria-labelledby="tabset-1-1-tab">
<p><img src="mapas/Arafo.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-2" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-2-tab">
<p><img src="mapas/Arico.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-3" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-3-tab">
<p><img src="mapas/Buenavista%20del%20Norte.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-4" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-4-tab">
<p><img src="mapas/El%20Rosario.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-5" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-5-tab">
<p><img src="mapas/El%20Sauzal.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-6" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-6-tab">
<p><img src="mapas/El%20Tanque.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-7" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-7-tab">
<p><img src="mapas/Fasnia.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-8" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-8-tab">
<p><img src="mapas/Garachico.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-9" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-9-tab">
<p><img src="mapas/La%20Guancha.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-10" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-10-tab">
<p><img src="mapas/La%20Matanza%20de%20Acentejo.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-11" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-11-tab">
<p><img src="mapas/La%20Victoria%20de%20Acentejo.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-12" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-12-tab">
<p><img src="mapas/Los%20Silos.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-13" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-13-tab">
<p><img src="mapas/San%20Juan%20de%20la%20Rambla.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-14" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-14-tab">
<p><img src="mapas/Santiago%20del%20Teide.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-15" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-15-tab">
<p><img src="mapas/Tegueste.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
<div id="tabset-1-16" class="tab-pane" role="tabpanel" aria-labelledby="tabset-1-16-tab">
<p><img src="mapas/Vilaflor.png" class="img-fluid" style="max-width:100%; max-height:80vh;"></p>
</div>
</div>
</div>
</section>
</section>
<section id="análisis-del-residuo" class="level1" data-number="4">
<h1 data-number="4"><span class="header-section-number">4</span> Análisis del residuo</h1>
<p>Tras varios procesos iterativos de revisión manual de casos, ajuste de los umbrales e implementación de mejoras se ha conseguido rebajar el <strong>residuo global hasta el 17,75 %</strong>.</p>
<div id="7b660c9f" class="cell" data-execution_count="19">
<div class="cell-output cell-output-display" data-execution_count="4">
<table class="dataframe table table-responsive table-sm table-striped small" id="tabla_no_asignados">

<thead>

<tr>

<th>
Municipio
</th>

<th>
Total HS
</th>

<th>
No asignados
</th>

<th>
No asignados (%)
</th>

</tr>

</thead>

<tbody>

<tr>

<td>
Fasnia
</td>

<td>
1000
</td>

<td>
356
</td>

<td>
35.60
</td>

</tr>

<tr>

<td>
El Tanque
</td>

<td>
566
</td>

<td>
150
</td>

<td>
26.50
</td>

</tr>

<tr>

<td>
San Juan de la Rambla
</td>

<td>
1025
</td>

<td>
260
</td>

<td>
25.37
</td>

</tr>

<tr>

<td>
Vilaflor de Chasna
</td>

<td>
418
</td>

<td>
106
</td>

<td>
25.36
</td>

</tr>

<tr>

<td>
La Matanza
</td>

<td>
1601
</td>

<td>
374
</td>

<td>
23.36
</td>

</tr>

<tr>

<td>
Arico
</td>

<td>
2173
</td>

<td>
506
</td>

<td>
23.29
</td>

</tr>

<tr>

<td>
Buenavista del Norte
</td>

<td>
1094
</td>

<td>
239
</td>

<td>
21.85
</td>

</tr>

<tr>

<td>
Santiago del Teide
</td>

<td>
1915
</td>

<td>
360
</td>

<td>
18.80
</td>

</tr>

<tr>

<td>
El Rosario
</td>

<td>
5197
</td>

<td>
927
</td>

<td>
17.84
</td>

</tr>

<tr>

<td>
Los Silos
</td>

<td>
1031
</td>

<td>
183
</td>

<td>
17.75
</td>

</tr>

<tr>

<td>
Arafo
</td>

<td>
1322
</td>

<td>
232
</td>

<td>
17.55
</td>

</tr>

<tr>

<td>
Santa Úrsula
</td>

<td>
2632
</td>

<td>
374
</td>

<td>
14.21
</td>

</tr>

<tr>

<td>
La Guancha
</td>

<td>
1022
</td>

<td>
135
</td>

<td>
13.21
</td>

</tr>

<tr>

<td>
El Sauzal
</td>

<td>
2008
</td>

<td>
257
</td>

<td>
12.80
</td>

</tr>

<tr>

<td>
Garachico
</td>

<td>
806
</td>

<td>
93
</td>

<td>
11.54
</td>

</tr>

<tr>

<td>
La Victoria
</td>

<td>
1710
</td>

<td>
183
</td>

<td>
10.70
</td>

</tr>

<tr>

<td>
Tegueste
</td>

<td>
1664
</td>

<td>
91
</td>

<td>
5.47
</td>

</tr>

</tbody>

<caption>
Tabla 2. Distribución por municipio de hogares pendientes de asignación
</caption>
</table>
</div>
</div>
<div class="callout callout-style-default callout-note callout-titled">
<div class="callout-header d-flex align-content-center">
<div class="callout-icon-container">
<i class="callout-icon"></i>
</div>
<div class="callout-title-container flex-fill">
Nota adicional
</div>
</div>
<div class="callout-body-container callout-body">
<p>En relación con los municipios con mayor porcentaje de hogares no asignados, podría observarse un patrón relacionado con la ruralidad y la capacidad administrativa del ente local. Los porcentajes más elevados se concentran principalmente en municipios rurales y con población dispersa, donde las entidades municipales de menor tamaño cuentan con información limitada y menor capacidad para garantizar una cobertura territorial completa.</p>
</div>
</div>
<p>Después de una evaluación detallada de las 20 calles con mayor número de registros pendientes (alrededor de 1.000 en total), se identificaron las siguientes casuísticas como las más frecuentes en la no asignación:</p>
<ul>
<li>Direcciones <strong>no recogidas en las fuentes comparadas</strong> ni tampoco identificables mediante vista en Google Maps (Ej: Ctra. General del Norte o Calle Caleta del Jurado 5)</li>
<li><strong>Hogares en parcelas sin edificar</strong> (Ej: Calle Limeras o urbanización en Calle Llanos del Poris).</li>
<li><strong>Agrupamientos de viviendas hacinadas</strong> sin portales recogidos en callejeros ni distinguibles a vista de Google Maps (Ej: Playa Barranco Hondo o Lugar Bocacangrejo).</li>
<li>Bloques de viviendas con muchos hogares <strong>sin portal geolocalizado</strong> pero que se comprueba que existen en vista de Google Maps (Ej: Calle Alcalde Juan García Dorta o Calle El Lajial).</li>
<li>Hogares con descripción de calle pero no identificables por numeración incompleta en descripciones de portal como <strong>0000S/999</strong> (Ej: Calle José Gregorio Yanes Dorta o Lugar Bocacangrejo).</li>
</ul>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>